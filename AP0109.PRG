STORE WGRUPO TO XGRUPO
SELECT 1
USE APCON INDEX APCON
*** ARCHIVOS SOLO PARA RECALCULO DE SOBRES
SELECT 2
USE APPERSON INDEX APPERSO1
SELECT 3
USE APCONPER INDEX APCONPER
SELECT 4
USE APPAGCON INDEX APPAGCO1, APPAGCO2
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   @ 4,0 CLEAR
   @ 04,0 SAY "CONCEPTOS NOMINALES"
   @ 5,0 TO 21,60
   @ 06,2 SAY "CODIGO      :"
   @ 07,2 SAY "DESCRIPCION :"
   @ 08,2 SAY "GRUPO       :"
   @ 09,2 SAY "SUBGRUPO    :"
   @ 10,2 SAY "UNIDAD      :"
   
   @ 14,2 SAY "ELEMENTOS DEL CALCULO"
   @ 15,2 SAY "TIPO        :"
   @ 16,2 SAY "FACTOR      :"
   @ 17,2 SAY "FRECUENCIA  :"
   @ 18,2 say "MINIMO      :"
   @ 19,2 SAY "MAXIMO      :"
   @ 20,2 say "SALDO TIPO  :"
   @ 06,16 GET WCONCEPTO
   READ
   IF WCONCEPTO = SPACE(4) .OR.READKEY()=12.OR.READKEY()=268
      EXIT
   ENDIF
   SELECT 1
   FIND &WCONCEPTO
   STORE .F. TO WFLAGRECAL
   IF EOF()
      STORE .T. TO WINGRESA
      STORE .T. TO WMODIFICA
      STORE "CONCEPTO NO REGISTRADO, INGRESAR ? (S/N)" TO TEX
      STORE "SN" TO WCH
      DO PREGUNTA
      IF WCH = "N"
         LOOP
      ENDIF
      STORE SPACE(25)        TO WDESCRI
      STORE SPACE(10)        TO WDESCRIR1
      STORE SPACE(10)        TO WDESCRIR2
      STORE 0                TO WGRUPO
      STORE 0                TO WSUBGRUPO
      STORE SPACE(4)         TO WUNIDAD
      STORE 0                TO WFORMA
      STORE 0                TO WFACTOR
      STORE 0                TO WFRECUEN
      STORE 0                TO WMINIMO
      STORE 999999           TO WMAXIMO
      STORE 0                TO WSALDOTIPO
   ELSE
      STORE .F. TO WINGRESA
      STORE .F. TO WMODIFICA
      STORE DESCRI           TO WDESCRI
      STORE DESCRIR1         TO WDESCRIR1
      STORE DESCRIR2         TO WDESCRIR2
      STORE GRUPO            TO WGRUPO
      STORE SUBGRUPO         TO WSUBGRUPO
      STORE UNIDAD           TO WUNIDAD
      STORE FORMA            TO WFORMA
      STORE FACTOR           TO WFACTOR
      STORE FRECUENCIA       TO WFRECUEN
      STORE MINIMO           TO WMINIMO
      STORE MAXIMO           TO WMAXIMO
      STORE SALDO            TO WSALDOTIPO
   ENDIF
   IF WGRUPO = 1
      STORE "ASIGNACION" TO WGRUPODES
      IF WSUBGRUPO = 1
         STORE "BONIFICABLE" TO WSUBGRUDES
      ELSE
         IF WSUBGRUPO = 2
            STORE "NO BONIFICABLE" TO WSUBGRUDES
         ELSE
            STORE SPACE(20) TO WSUBGRUDES
         ENDIF
      ENDIF
   ELSE
      IF WGRUPO = 2
         STORE "DEDUCCION" TO WGRUPODES
         IF WSUBGRUPO = 1
            STORE "LEGAL y/o CONTRACTUAL" TO WSUBGRUDES
         ELSE
            IF WSUBGRUPO = 2
               STORE "OTRAS DEDUCCIONES" TO WSUBGRUDES
            ELSE
               STORE SPACE(20) TO WSUBGRUDES
            ENDIF
         ENDIF
      ELSE
         STORE SPACE(20) TO WGRUPODES
         STORE SPACE(20) TO WSUBGRUDES
      ENDIF
   ENDIF
   DO CASE
      CASE WFORMA = 0
           STORE SPACE(20) TO WFORMADES
      CASE WFORMA = 1
           STORE "MONTO DIRECTO" TO WFORMADES
      CASE WFORMA = 2
           STORE "% BASICO x HORA" TO WFORMADES
      CASE WFORMA = 3
           STORE "% BASICO DIARIO" TO WFORMADES
      CASE WFORMA = 4
           STORE "% BASICO x PERIODO" TO WFORMADES
      CASE WFORMA = 5
           STORE "% BONIFICABLE" TO WFORMADES
      CASE WFORMA = 6
           STORE "% ASIGNACIONES" TO WFORMADES
      CASE WFORMA = 7
           STORE "FORMULA:APPR"+RTRIM(LTRIM(WCONCEPTO)) TO WFORMADES
   ENDCASE
   DO CASE
      CASE WFRECUEN = 0
           STORE "PERMANENTE" TO WFRECUENDES
      CASE WFRECUEN = 1
           STORE "FIN DE MES" TO WFRECUENDES
      CASE WFRECUEN = 2
           STORE "EVENTUAL"   TO WFRECUENDES
   ENDCASE
   DO CASE
      CASE WSALDOTIPO = 0
           STORE "NO MANEJA SALDO    " TO WSALDODES
      CASE WSALDOTIPO = 1
           STORE "INICIAL + PROCESADO" TO WSALDODES
      CASE WSALDOTIPO = 2
           STORE "INICIAL - PROCESADO" TO WSALDODES
   ENDCASE
   @ 7, 16 SAY WDESCRI
   @ 7, 50 SAY WDESCRIR1
   @ 7, 60 SAY WDESCRIR2
   @ 8, 16 SAY WGRUPO  PICTURE "#"
   @ 8, 18 SAY " = "+WGRUPODES
   @ 9, 16 SAY WSUBGRUPO PICTURE "#"
   @ 9, 18 SAY " = "+WSUBGRUDES
   @ 10,16 SAY WUNIDAD
   @ 15,16 SAY WFORMA PICTURE "#"
   @ 15,18 SAY " = "+WFORMADES
   @ 16,16 SAY WFACTOR PICTURE "#######.###"
   @ 17,16 SAY WFRECUEN PICTURE "#"
   @ 17,18 SAY " = "+WFRECUENDES
   @ 18,16 SAY WMINIMO PICTURE "#######.##"
   @ 19,16 SAY WMAXIMO PICTURE "#######.##"
   @ 20,16 SAY WSALDOTIPO PICTURE "#"
   @ 20,18 SAY " = "+WSALDODES
   IF .NOT. WMODIFICA
      STORE "OPCIONES: (M)ODIFICAR, (E)LIMINAR, (S)ALIR" TO TEX
      STORE "SEM" TO WCH
      DO PREGUNTA
      STORE WCH TO WRESP
      IF WRESP= "S"
         LOOP
      ELSE
         IF WRESP= "M"
            STORE .T. TO WMODIFICA
         ELSE
            STORE "ESTA SEGURO QUE DESEA ELIMINAR ? (S/N)" TO TEX
            STORE "NS" TO WCH
            DO PREGUNTA
            IF WCH = "N"
               LOOP
            ELSE
               *** CHEQUEAR QUE EL CONCEPTO ESTE SIN CONEXIONES EN APCONPER.DBF
                SELECT 1
                DELETE
                LOOP
            ENDIF
         ENDIF
      ENDIF
   ENDIF

   IF WMODIFICA
      *** DESCRIPCION
      STORE .T. TO WACT
      DO WHILE WACT
         STORE "INGRESE LA DESCRIPCION DEL CONCEPTO NOMINAL" TO MES
         DO MENSAJE WITH MES
         @ 7, 16 GET WDESCRI
         @ 7, 50 GET WDESCRIR1
         @ 7, 60 GET WDESCRIR2
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WDESCRI <> SPACE(25)
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF
      *** GRUPO
      STORE .T. TO WACT
      DO WHILE WACT
         STORE "OPCIONES: 1=ASIGNACION, 2=DEDUCCION" TO MES
         DO MENSAJE WITH MES
         @ 8,16 GET WGRUPO PICTURE "#" RANGE 1,2
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WGRUPO = 1 .OR. WGRUPO = 2
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF
      *** SUBGRUPO
      STORE .T. TO WACT
      DO WHILE WACT
         IF WGRUPO = 1
            STORE "OPCIONES: 1=BONIFICABLE, 2=NO BONIFICABLE" TO MES
         ELSE
            STORE "OPCIONES: 1=LEGAL y/o CONTRACTUAL, 2=OTRAS DEDUCCIONES" TO MES
         ENDIF
         DO MENSAJE WITH MES
         @ 9,16 GET WSUBGRUPO PICTURE "#" RANGE 1,2
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WSUBGRUPO = 1 .OR. WSUBGRUPO = 2
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF
      *** UNIDAD
      STORE .T. TO WACT
      DO WHILE WACT
         STORE "INDIQUE LA UNIDAD DE MEDIDA DEL CONCEPTO" TO MES
         DO MENSAJE WITH MES
         @ 10,16 GET WUNIDAD
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WUNIDAD <> SPACE(4)
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF

      *** FORMA
      STORE WFORMA TO WLASTFORMA
      DO WHILE WACT
         STORE "1=MONTO,2=%BAS/Hr,3=% BAS/DIA,4=%BAS/PERD,5=% BONIFIC.,6=% ASIGNAC.,7=FORMULA" TO MES
         DO MENSAJE WITH MES
         @ 15,16 GET WFORMA PICTURE "#" RANGE 1,7
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            STORE WLASTFORMA TO WFORMA
            EXIT
         ENDIF
         IF WFORMA = 7 
            STORE "APPR"+WCONCEPTO+".FOX" TO WWFILE1
            STORE "APPR"+WCONCEPTO+".PRG" TO WWFILE2
            IF FILE(WWFILE1) .OR. FILE(WWFILE2)
               *** NO PROBLEM
            ELSE
               *** SI PROBLEM
               STORE "PRIMERO DEBE CREAR LA FORMULA O RUTINA "+WWFILE1 TO MES
               DO AVISO WITH MES
               LOOP
            ENDIF
         ENDIF
         IF WFORMA > 0 .AND. WFORMA < 8
            IF WLASTFORMA <> WFORMA
               STORE .T. TO WFLAGRECAL
            ENDIF
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF
      *** FACTOR
      DO WHILE WACT
         STORE "INGRESE EL FACTOR A APLICAR EN LA FORMA DE CALCULO SELECCIONADA" TO MES
         DO MENSAJE WITH MES
         @ 16,16 GET WFACTOR PICTURE "#######.###"
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WFACTOR > 0
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF

      *** Frecuencia
      STORE WFRECUEN TO WLASTFREC
      DO WHILE WACT
         STORE "FRECUENCIA DE PAGO: 0=PERMANENTE, 1=FIN DE MES, 2=EVENTUAL"  TO MES
         DO MENSAJE WITH MES
         @ 17,16 GET WFRECUEN PICTURE "#"
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WACT
            STORE WLASTFREC TO WFRECUEN
            EXIT
         ENDIF
         IF WFRECUEN >= 0 .AND. WFRECUEN <=2 
            IF WLASTFREC <> WFRECUEN
               STORE .T. TO WFLAGRECAL
            ENDIF
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WACT
         LOOP
      ENDIF


      *** minimo y maximo
      DO WHILE WACT
         STORE "INGRESE EL MINIMO Y MAXIMO A CALCULAR DEL CONCEPTO" TO MES
         DO MENSAJE WITH MES
         @ 18,16 GET WMINIMO PICTURE "#######.##"
         @ 19,16 GET WMAXIMO PICTURE "#######.##"
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            EXIT
         ENDIF
         IF WMAXIMO >= WMINIMO
           EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF

      *** SALDO
      STORE WSALDOTIPO TO WLASTSALDO
      DO WHILE WACT
         STORE "DEFINA CALCULO DE SALDO: 0=NINGUNO, 1=INICIAL+PROCESADO, 2=INICIAL-PROCESADO" TO MES
         DO MENSAJE WITH MES
         @ 20,16 GET WSALDOTIPO PICTURE "#"
         READ
         IF READKEY()=12.OR.READKEY()=268
            STORE .F. TO WCARGANDO
            STORE WLASTSALDO TO WSALDOTIPO
            EXIT
         ENDIF
         IF WSALDOTIPO>=0 .AND. WSALDOTIPO <=2
            IF WLASTSALDO <> WSALDOTIPO
               STORE .T. TO WFLAGRECAL
            ENDIF
            EXIT
         ENDIF
      ENDDO
      IF .NOT. WCARGANDO
         EXIT
      ENDIF

   ENDIF
   STORE "CONFORME ? (S/N)" TO TEX
   STORE "SN" TO WCH
   DO PREGUNTA
   IF WCH = "N"
      LOOP
   ENDIF
   IF WINGRESA
      DO FILLOC
      APPEND BLANK
      UNLOCK
      DO RECLOC
      REPLACE CODIGO WITH WCONCEPTO
   ENDIF
   DO RECLOC
   REPLACE DESCRI     WITH WDESCRI
   REPLACE DESCRIR1   WITH WDESCRIR1
   REPLACE DESCRIR2   WITH WDESCRIR2
   REPLACE GRUPO      WITH WGRUPO
   REPLACE SUBGRUPO   WITH WSUBGRUPO
   REPLACE UNIDAD     WITH WUNIDAD
   REPLACE FORMA      WITH WFORMA
   REPLACE FACTOR     WITH WFACTOR
   REPLACE FRECUENCIA WITH WFRECUEN
   REPLACE MINIMO     WITH WMINIMO
   REPLACE MAXIMO     WITH WMAXIMO
   REPLACE SALDO      WITH WSALDOTIPO
   FLUSH
   UNLOCK
   IF WFLAGRECAL
      STORE "DESEA RECALCULAR CONCEPTO EN LAS NOMINAS EN ELABORACION ? (S/N)" TO TEX
      STORE "NS" TO WCH
      DO PREGUNTA
      IF WCH = "N"
         LOOP
      ENDIF
      *** RECALCULO DE LOS SOBRES DEL CONCEPTO MODIFICADO
      STORE WCONCEPTO TO WCONREC
      SELECT APPAGCON
      SET ORDER TO 2
      FIND &WCONREC
      DO WHILE .NOT. EOF() .AND. CONCEPTO = WCONREC
         STORE RECNO() TO WREGISTRO
         STORE CEDULA  TO XCEDULA
         SELECT APPERSON
         FIND &XCEDULA
         IF EOF()
            SELECT APPAGCON
            SET ORDER TO 2
            GO WREGISTRO
            SKIP
            LOOP
         ENDIF
         *** RUTINA DE RECALCULO DEL SOBRE
         STORE 0 TO WTOTBON
         STORE 0 TO WTOTNBON
         STORE 0 TO WTOTASI
         STORE 0 TO WTOTDEC
         STORE 0 TO WTOTLIQ
         SELECT APPAGCON
         SET ORDER TO 1
         DO SOBRECAL
         SELECT APPAGCON
         SET ORDER TO 2
         GO WREGISTRO
         SKIP
      ENDDO
   ENDIF
ENDDO
STORE XGRUPO TO WGRUPO
CLOSE DATA
CLOSE INDEX
RETURN

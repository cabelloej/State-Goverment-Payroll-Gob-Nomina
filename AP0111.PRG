SELECT 1 
USE APPERSON INDEX APPERSO1,APPERSO2,APPERSO3,APPERSO4
SELECT 2
USE APGRUPOS INDEX APGRUPOS
SELECT 3
USE APNOMINA INDEX APNOMINA
SELECT 4
USE APUBICA INDEX APUBICA
SELECT 5
USE APCARGOS INDEX APCARGOS
SELECT 7
USE APCON INDEX APCON
SELECT 8
USE APCONPER INDEX APCONPER
SELECT 9
USE APPAGCON INDEX APPAGCO1
SELECT 10
USE APPAGGEN INDEX APPAGGE1
STORE .T. TO PER
DO WHILE PER
   SELECT 1
   STORE 04 TO LINE
   STORE 0 TO COL
   @ LINE,COL CLEAR
   @ LINE,COL TO LINE+17,COL+79 DOUBLE
   STORE "INGRESE LOS SIGUIENTES DATOS LABORALES" TO MES
   DO MENSAJE WITH MES
   @ LINE,COL+32 SAY "DATOS LABORALES"
   @ 05,1 SAY   "CEDULA:             NOMBRE:                     APELLIDOS :"
   @ 06,1 SAY   "------------------- --------------------------- ------------------------------"
   @ 07,1 SAY   "GRUPO .....:                                    CENTRO PAGO:                  "
   @ 08,1 SAY   "NOMINA ....:                                    CONTRATO   :                  "
   @ 09,1 SAY   "DIREC-PROG.:                                    SINDICATO  :                  "
   @ 10,1 SAY   "DEPTO-MUNI.:                                    VAC.VENCEN :                  "
   @ 11,1 SAY   "SECC.-UNID.:                                    VAC.SALIDA :                  "
   @ 12,1 SAY   "CARGO .....:                                    VAC.RETORNO:                  "
   @ 13,1 SAY   "TIPO/HRxDIA:                                         "
   @ 14,1 SAY   "S.Hr/Dia/Pr:                                        "
   @ 15,1 SAY   "ESTATUS ...:                                         "
   @ 16,1 SAY   "INGRESO....:                                         "
   @ 17,1 SAY   "EGRESO ....:                                         "
   @ 18,1 SAY   "ACREDIT.BCO:                                         "
   @ 19,1 SAY   "CTA BCRIA.#:                                         "
   @ 20,1 SAY   "CTA CAJA  #:                                         "
   @ 5,8 GET WCEDULA
   READ
   IF WCEDULA = SPACE(12) .OR. READKEY()=12 .OR. READKEY()=268
      EXIT
   ENDIF
   SELECT 1
   FIND &WCEDULA
   IF EOF()
      STORE "CEDULA NO REGISTRADA, FAVOR INGRESAR POR FICHA PERSONAL" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   @ 5,28 SAY NOMBRES
   @ 5,60 SAY SUBSTR(APELLIDOS,1,18)
   STORE GRUPO     TO WGRUPO
   STORE NOMINA    TO WNOMINA
   STORE DIRE      TO WDIRE
   STORE DEPA      TO WDEPA
   STORE SECC      TO WSECC
   STORE CARGO     TO WCARGO
   STORE SUELDOH   TO WSUELDOH
   STORE SUELDOD   TO WSUELDOD
   STORE SUELDOP   TO WSUELDOP
   STORE TIPO      TO WTIPO
   STORE HORASDIA  TO WHORASDIA
   STORE ESTATUS   TO WESTATUS
   STORE INGRESO   TO WINGRESO
   STORE EGRESO    TO WEGRESO
   STORE BANCO     TO WBANCOCOD
   STORE CTABANCO  TO WCTABANCO
   STORE CTACAJA   TO WCTACAJA
   STORE CENTROPAGO TO WCENTRO
   STORE CONTRATO   TO WCONTRATO
   STORE SINDICATO  TO WSINDICATO
   STORE VENCEVAC   TO WVENCEVAC
   STORE SALIDAVAC  TO WSALIDAVAC
   STORE RETORNOVAC TO WRETORNOVAC

   IF WGRUPO <> SPACE(2)
      SELECT 2
      FIND &WGRUPO
      IF EOF()
         STORE "NO REGISTRADO" TO WGRUPODES
      ELSE
         STORE DESCRI          TO WGRUPODES
      ENDIF
   ELSE
      STORE "NO DEFINIDO"    TO WGRUPODES
   ENDIF
   STORE WGRUPO+WNOMINA TO WCLAVE
   IF WCLAVE <> SPACE(4)
      SELECT 3
      FIND &WCLAVE
      IF EOF()
         STORE "NO REGISTRADO" TO WNOMINADES
      ELSE
         STORE DESCRI          TO WNOMINADES
      ENDIF
   ELSE
      STORE "NO DEFINIDO"    TO WNOMINADES
   ENDIF
   IF WDIRE <> SPACE(2)
      STORE WDIRE+"00"+"000" TO WCLAVE
      SELECT 4
      FIND &WCLAVE
      IF EOF()
         STORE "NO REGISTRADO" TO WDIREDES
      ELSE
         STORE DESCRI          TO WDIREDES
      ENDIF
   ELSE
      STORE "NO DEFINIDO"     TO WDIREDES
   ENDIF
   SELECT 4
   IF WDIRE <> SPACE(2) .AND. WDEPA <> SPACE(2)
      STORE WDIRE+WDEPA+"000" TO WCLAVE
      FIND &WCLAVE
      IF EOF()
         STORE "NO REGISTRADO" TO WDEPADES
      ELSE
         STORE DESCRI          TO WDEPADES
      ENDIF
   ELSE
      STORE "NO DEFINIDO"     TO WDEPADES
   ENDIF
   IF WDIRE <> SPACE(2) .AND. WDEPA <> SPACE(2) .AND. WSECC <> SPACE(3)
      SELECT 4
      STORE WDIRE+WDEPA+WSECC TO WCLAVE
      FIND &WCLAVE
      IF EOF()
         STORE "NO REGISTRADO" TO WSECCDES
      ELSE
         STORE DESCRI          TO WSECCDES
      ENDIF
   ELSE
      STORE "NO DEFINIDO"     TO WSECCDES
   ENDIF
   IF WCARGO <> SPACE(LEN(WCARGO))
      SELECT 5
      FIND &WCARGO
      IF EOF()
         STORE "NO REGISTRADO" TO WCARGODES
      ELSE
         STORE DESCRI          TO WCARGODES
      ENDIF
   ELSE
      STORE "NO DEFINIDO" TO WCARGODES
   ENDIF

   IF WCENTRO <> SPACE(2)
      SELECT 6
      USE APcentro INDEX APcentro
      FIND &WCENTRO
      IF EOF()
         STORE "NO REGISTRADO" TO WCENTRODES
      ELSE
         STORE DESCRI          TO WCENTRODES
      ENDIF
   ELSE
      STORE "NO DEFINIDO" TO WCENTRODES
   ENDIF

   IF WCONTRATO   <> SPACE(2)
      SELECT 6
      USE APCONTRA INDEX APCONTRA
      FIND &WCONTRATO
      IF EOF()
         STORE "NO REGISTRADO" TO WCONTRADES
      ELSE
         STORE DESCRI          TO WCONTRADES
      ENDIF
   ELSE
      STORE "NO DEFINIDO" TO WCONTRADES
   ENDIF

   IF WSINDICATO  <> SPACE(2)
      SELECT 6
      USE APSINDIC INDEX APSINDIC
      FIND &WSINDICATO
      IF EOF()
         STORE "NO REGISTRADO" TO WSINDICADES
      ELSE
         STORE DESCRI          TO WSINDICADES
      ENDIF
   ELSE
      STORE "NO DEFINIDO" TO WSINDICADES
   ENDIF

   IF Wbancocod  <> SPACE(2)
      SELECT 6
      USE APbancos INDEX APbancos
      FIND &Wbancocod
      IF EOF()
         STORE "NO REGISTRADO" TO Wbancodes 
      ELSE
         STORE DESCRI          TO Wbancodes 
      ENDIF
   ELSE
      STORE "NO DEFINIDO" TO Wbancodes 
   ENDIF
   @ 07,13 SAY WGRUPO
   @ 07,21 SAY WGRUPODES
   @ 08,13 SAY WNOMINA
   @ 08,21 SAY WNOMINADES
   @ 09,13 SAY WDIRE
   @ 09,21 SAY WDIREDES
   @ 10,13 SAY WDEPA
   @ 10,21 SAY WDEPADES
   @ 11,13 SAY WSECC
   @ 11,21 SAY WSECCDES
   @ 12,13 SAY WCARGO
   @ 12,21 SAY substr(WCARGODES,1,25)
   @ 13,13 SAY WTIPO
   @ 13,15 SAY WHORASDIA PICTURE "##.##"
   @ 14,13 SAY WSUELDOH PICTURE "####.##"
   @ 14,21 SAY WSUELDOD PICTURE "#####.##"
   @ 14,31 SAY WSUELDOP PICTURE "######.##"
   @ 15,13 SAY WESTATUS
   @ 16,13 SAY WINGRESO
   @ 17,13 SAY WEGRESO
   @ 18,13 SAY WBANCOCOD
   @ 18,21 SAY WBANCODES
   @ 19,13 SAY WCTABANCO
   @ 20,13 SAY WCTACAJA
   @ 07,61 SAY WCENTRO+" "+WCENTRODES
   @ 08,61 SAY WCONTRATO+" "+WCONTRADES
   @ 09,61 SAY WSINDICATO+" "+WSINDICADES
   @ 10,61 SAY WVENCEVAC
   @ 11,61 SAY WSALIDAVAC
   @ 12,61 SAY WRETORNOVAC
   STORE "OPCIONES: (M)ODIFICAR, (S)ALIR" TO TEX
   STORE "SM" TO WCH
   DO PREGUNTA
   IF WCH = "S"
      LOOP
   ENDIF
   STORE WGRUPO  TO WLASTGRU
   STORE WNOMINA TO WLASTNOM
   @ 07,13 GET WGRUPO
   READ
   IF WGRUPO=SPACE(2).OR.READKEY()=12.OR.READKEY()=268
      LOOP
   ENDIF
   SELECT 2
   FIND &WGRUPO
   IF EOF()
      STORE "GRUPO DE NOMINA NO REGISTRADO" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   @ 07,21 SAY DESCRI
   @ 08,13 GET WNOMINA
   READ
   IF WNOMINA=SPACE(2).OR.READKEY()=12.OR.READKEY()=268
      LOOP
   ENDIF
   STORE WLASTGRU+WLASTNOM TO WLASTCLAVE
   STORE WGRUPO+WNOMINA    TO WCLAVENOM
   IF WLASTCLAVE <> WCLAVENOM
      SELECT 3
      FIND &WCLAVENOM
      IF EOF()
         STORE "NUEVO CODIGO DE NOMINA NO REGISTRADO EN ESTE GRUPO" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      @ 08,21 SAY DESCRI
      IF ESTADO > 1
         STORE "ERROR, ESTADO DE LA NUEVA NOMINA NO PERMITE CAMBIO DE CODIGOS" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF   
      IF WLASTCLAVE <> SPACE(4)
         SELECT 3
         FIND &WLASTCLAVE
         IF EOF() 
            STORE "ERROR, ANTIGUO CODIGO DE NOMINA NO REGISTRADO EN NOMINAS" TO MES
            DO AVISO WITH MES
            LOOP
         ELSE
            IF ESTADO > 1
               STORE "ERROR, ESTADO DE LA NOMINA ANTERIOR NO PERMITE CAMBIO DE CODIGOS" TO MES
               DO AVISO WITH MES
               LOOP
            ENDIF
         ENDIF         
      ENDIF
   ENDIF
   SELECT 3
   FIND &WCLAVENOM
   IF EOF()
      STORE "NOMINA INVALIDA" TO MES
      DO AVISO WITH MES
      LOOP
   ELSE
      STORE ESTADO TO WESTADO
   ENDIF
   IF WESTADO < 2
      @ 09,13 GET WDIRE
      READ
      @ 10,13 GET WDEPA
      READ
      @ 11,13 GET WSECC
      READ
   ENDIF
   @ 12,13 GET WCARGO
   READ
   IF WESTADO < 2
      store .t. to wgettipo
      do while wgettipo
         @ 13,13 GET WTIPO picture "!"
         read
         if wtipo = "O" .or. wtipo = "E" .or. wtipo = "J" .or. wtipo = "P"
            exit
         endif
      enddo
      if .not. wgettipo
         loop
      endif
      store .t. to wverhor
      do while wverhor
         @ 13,15 GET WHORASDIA PICTURE "##.##" range 1,24
         READ
         if whorasdia > 0
            exit
         endif
      enddo
      IF WTIPO = "O"
         @ 14,21 GET WSUELDOD PICTURE "#####.##"
         READ
         STORE WSUELDOD*7 TO WSUELDOP
         STORE WSUELDOD/WHORASDIA TO WSUELDOH
      ELSE
         IF WTIPO = "E" .or. wtipo = "J" .or. wtipo = "P" 
            @ 14,31 GET WSUELDOP PICTURE "######.##"
            READ
            STORE WSUELDOP/30 TO WSUELDOD
            STORE WSUELDOD/WHORASDIA  TO WSUELDOH
         ENDIF
      ENDIF
      @ 14,13 SAY WSUELDOH PICTURE "####.##"
      @ 14,21 SAY WSUELDOD PICTURE "#####.##"
      @ 14,31 SAY WSUELDOP PICTURE "######.##"
      @ 15,13 GET WESTATUS
      READ
   ENDIF
   @ 16,13 GET WINGRESO
   READ
   @ 17,13 GET WEGRESO
   READ
   STORE .T. TO WGETBAN
   DO WHILE WGETBAN
      @ 18,13 GET WBANCOCOD
      READ
      @ 19,13 GET WCTABANCO
      READ
      IF WBANCOCOD <> SPACE(2) .AND. WCTABANCO <> SPACE(20)
         EXIT
      ENDIF
   ENDDO
   @ 20,13 GET WCTACAJA
   READ
   @ 07,61 GET WCENTRO
   READ
   @ 08,61 GET WCONTRATO
   READ
   @ 09,61 GET WSINDICATO
   READ
   @ 10,61 GET WVENCEVAC
   READ
   @ 11,61 GET WSALIDAVAC
   READ
   @ 12,61 GET WRETORNOVAC
   READ
   STORE "CONFORME ? (S/N)" TO TEX
   STORE "SN" TO WCH
   DO PREGUNTA
   IF WCH = "N"
      LOOP
   ENDIF
   SELECT 1
   DO RECLOC
   REPLACE GRUPO     WITH WGRUPO
   REPLACE NOMINA    WITH WNOMINA
   REPLACE DIRE      WITH WDIRE
   REPLACE DEPA      WITH WDEPA
   REPLACE SECC      WITH WSECC
   REPLACE CARGO     WITH WCARGO
   REPLACE SUELDOH   WITH WSUELDOH
   REPLACE SUELDOD   WITH WSUELDOD
   REPLACE SUELDOP   WITH WSUELDOP
   REPLACE TIPO      WITH WTIPO
   REPLACE HORASDIA  WITH WHORASDIA
   REPLACE ESTATUS   WITH WESTATUS
   REPLACE INGRESO   WITH WINGRESO
   REPLACE EGRESO    WITH WEGRESO
   REPLACE BANCO     WITH WBANCOCOD
   REPLACE CTABANCO  WITH WCTABANCO
   REPLACE CTACAJA   WITH WCTACAJA
   REPLACE CENTROPAGO WITH WCENTRO
   REPLACE CONTRATO   WITH WCONTRATO
   REPLACE SINDICATO  WITH WSINDICATO
   REPLACE VENCEVAC   WITH WVENCEVAC
   REPLACE SALIDAVAC  WITH WSALIDAVAC
   REPLACE RETORNOVAC WITH WRETORNOVAC
   FLUSH
   UNLOCK
   SELECT 10
   FIND &WCEDULA
   IF .NOT. EOF()
      DO RECLOC
      REPLACE GRUPO   WITH WGRUPO
      REPLACE NOMINA  WITH WNOMINA
      REPLACE DIRE    WITH WDIRE
      REPLACE DEPA    WITH WDEPA
      REPLACE SECC    WITH WSECC
      REPLACE CARGO   WITH WCARGO
      REPLACE SUELDOH WITH WSUELDOH
      REPLACE SUELDOD WITH WSUELDOD
      REPLACE SUELDOP WITH WSUELDOP
      REPLACE TIPO    WITH WTIPO
      FLUSH
      UNLOCK
   ENDIF
   *** RUTINA DE RECALCULO DEL SOBRE
   STORE 0 TO WTOTBON
   STORE 0 TO WTOTNBON
   STORE 0 TO WTOTASI
   STORE 0 TO WTOTDEC
   STORE 0 TO WTOTLIQ
   STORE WCEDULA TO XCEDULA
   DO SOBRECAL
   DO CONCECAL
ENDDO
CLOSE DATA
CLOSE INDEX
RETURN


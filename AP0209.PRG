SELECT 3
USE APNOMBAN
COPY STRU TO &WUSERCODE 
SELECT 3
USE &WUSERCODE
STORE ALLTRIM(WUSERCODE)+"1" TO WUSERBAN1
STORE ALLTRIM(WUSERCODE)+"2" TO WUSERBAN2
INDEX ON CEDULA       TO &WUSERBAN1
INDEX ON BANCO+CEDULA TO &WUSERBAN2
DIME APNOM(50,2)
STORE 0 TO WCONTNOM
@ 4,0 CLEAR to 14,79
@ 5,0 TO 14,79
@ 04,00 SAY "NOMINA BANCARIA"
@ 06,2 SAY "GRUPO                  :"
@ 08,2 SAY "NOMINA                 :"
@ 10,2 SAY "FECHA DE CIERRE INICIAL:"
@ 12,2 SAY "FECHA DE CIERRE FINAL  :"
SAVE SCRE TO SCREPRI
STORE .F. TO WFLAGSCRE
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   IF WFLAGSCRE
      @ 0,0 CLEAR
      RESTORE SCRE FROM SCREPRI
   ELSE
      STORE .T. TO WFLAGSCRE
   ENDIF
   SELECT 1
   USE APGRUPOS INDEX APGRUPOS
   STORE .T. TO WCARGANDO
   SELECT 2
   USE APNOMINA INDEX APNOMINA
   STORE "OPRIMA <ESC> PARA IMPRIMIR LISTADO BANCARIO DE NOMINAS SELECCIONADAS" TO MES
   DO MENSAJE WITH MES
   @ 06,26 GET WGRUPO
   READ
   IF WGRUPO = SPACE(2) .OR.READKEY()=12.OR.READKEY()=268
      EXIT
   ENDIF
   SELECT 1
   FIND &WGRUPO
   IF EOF()
      STORE "GRUPO NO REGISTRADO, VERIFIQUE, OPRIMA <ENTER>" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   STORE DESCRI TO WGRUPODES
   @ 06,30 SAY WGRUPODES
   ************************************************************************
   *** SE ESTA PERMITIENDO IMPRIMIR TODAS LAS NOMINAS DE UN GRUPO,        *
   *** PERO HAY QUE CONSIDERAR QUE LAS DIFERENTES NOMINAS DE UN GRUPO     *
   *** PUEDEN TENER DIFERENTES LAPSOS Y FECHAS DE PROCESO QUE NO SABEMOS  *
   *** SI AFECTE LA VERACIDAD DEL INFORME DE NOMINA VERTICAL .            *
   *** POR CONSIGUIENTE, SE RECOMIENDA SOLICITAR NOMINA POR NOMINA.       *
   ************************************************************************
   @ 08,26 GET WNOMINA
   READ
   IF READKEY()=12.OR.READKEY()=268
      LOOP
   ENDIF
   IF WNOMINA = SPACE(2)
   *   STORE "TODAS LAS DEL GRUPO" TO WNOMIDES
   *   @ 08,30 SAY WNOMIDES
   *   SELECT 2
   *   FIND &WGRUPO
   *   STORE APER2 TO WXAP1
   *   STORE APER2 TO WXAP2
   *   @ 10,26 GET WXAP1
   *   @ 12,26 GET WXAP2
   *   READ
   *   IF WXAP2<WXAP1
   *      STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
   *      DO AVISO WITH MES
   *      LOOP
   *   ENDIF
   *   STORE .F. TO WFLAGNO
   *   DO WHILE .NOT. EOF() .AND. GRUPO = WGRUPO
   *      IF ESTADO = 0
   *         STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
   *         DO AVISO WITH MES
   *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
   *         DO AVISO WITH MES
   *         STORE .T. TO WFLAGNO
   *         EXIT
   *      ENDIF
   *      IF (APER2>=WXAP1 .AND. APER2<=WXAP2)
   *         *** TODO BIEN
   *      ELSE
   *         STORE "ERROR: NOMINA "+NOMINA+" CON PERIODO DE PAGO FUERA DEL RANGO" TO MES
   *         DO AVISO WITH MES
   *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
   *         DO AVISO WITH MES
   *         STORE .T. TO WFLAGNO
   *         EXIT
   *      ENDIF
   *      SKIP
   *   ENDDO
   *   IF WFLAGNO
   *      LOOP
   *   ENDIF
       LOOP
   ELSE
      STORE .F. TO WFLAGNO
      SELECT 2
      STORE WGRUPO+WNOMINA TO WCLAVEX
      FIND &WCLAVEX
      IF EOF()
         STORE "NOMINA NO REGISTRADA. VERIFIQUE" TO MES
         DO AVISO WITH MES
         LOOP
      ELSE
         STORE DESCRI TO WNOMIDES
      ENDIF
      @ 08,30 SAY WNOMIDES
      STORE APER2 TO WXAP1
      STORE APER2 TO WXAP2
      @ 10,26 SAY WXAP1
      @ 12,26 SAY WXAP2
      IF WXAP2<WXAP1
         STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      IF ESTADO = 0
         STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
   ENDIF
   STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" TO TEX
   STORE "CR" TO WCH
   DO PREGUNTA
   IF WCH = "R"
      LOOP
   ENDIF
   STORE WCONTNOM + 1 TO WCONTNOM
   STORE WGRUPODES TO APNOM(WCONTNOM,1)
   STORE WNOMIDES  TO APNOM(WCONTNOM,2)
   STORE "PROCESANDO INFORMACION, FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   *** DATOS A TRANSFERIR A APNOMBAN
   ***
   STORE "APPAGGEN.DBF" TO QGENFIL
   STORE "APPAGGE2.IDX" TO QGENIDX
   STORE "APPAGCON.DBF" TO QCONFIL
   STORE "APPAGCO1.IDX" TO QCONIDX
   STORE WGRUPO         TO QGRUPO
   STORE WNOMINA        TO QNOMINA
   STORE WXAP1          TO QDESDE
   STORE WXAP2          TO QHASTA
   CLOSE DATA
   CLOSE INDEX
   DO APNOMBAN
   SET DEVI TO SCRE
ENDDO
*** IMPRESION DE APNOMBAN.DBF
CLOSE DATA
CLOSE INDEX
STORE "DESEA IMPRIMIR EL LISTADO BANCARIO DE LAS NOMINAS SELECCIONADAS ? (S/N)" TO TEX
STORE "SN" TO WCH
DO PREGUNTA
IF WCH = "N"
   RETURN
ENDIF
SET DEVI       TO PRINT
STORE 100      TO WLINE
STORE 0        TO WPAGE
STORE WCONTNOM TO WTOTCONT
STORE 0        TO WCONTNOM
DO WHILE WCONTNOM <=200
   STORE WCONTNOM+1 TO WCONTNOM
   IF WCONTNOM > WTOTCONT
      EXIT
   ENDIF
   STORE WLINE+1 TO WLINE
   IF WLINE >=55
      @ 0,00 SAY CHR(14)+QQWW
      @ 1,00 SAY "SISTEMA DE NOMINA"
      @ 3,00 SAY "LISTADO DE NOMINAS PROCESADAS EN EL LISTADO"
      @ 5,00 SAY "GRUPO"
      @ 5,35 SAY "NOMINA"
      @ 6,00 SAY "------------------------------"
      @ 6,35 SAY "------------------------------"
      STORE 7 TO WLINE
   ENDIF
   @ WLINE,00 SAY APNOM(WCONTNOM,1)
   @ WLINE,35 SAY APNOM(WCONTNOM,2)
ENDDO
EJECT
SELECT 1
USE APBANCOS INDEX APBANCOS
SELECT 2
USE &WUSERCODE INDEX &WUSERBAN2
SELECT 3
USE APDISBAN 
SELECT 10
USE APMONTO
STORE "**"      TO WRUPBAN
STORE SPACE(25) TO WBANDES
STORE 100       TO WLINEA
STORE 0         TO WPAGINA
STORE 0         TO WTOTBAN
STORE 0         TO WTOTREP
STORE 0         TO WCONTEO
SELECT 2
GO TOP
DO WHILE .NOT. EOF()
   IF BANCO <> WRUPBAN
      *** CREA ARCHIVO DE DATOS DEL PAGO
      STORE "BANCO"+RTRIM(BANCO) TO WDISBAN
      SELECT 3
      COPY STRU TO &WDISBAN
      SELECT 4
      USE &WDISBAN
      *** COPIA EN DISCO ULTIMO ARCHIVO CARGADO
      STORE WRUPBAN TO WLASTBAN
      STORE WBANDES TO WLASTBANDES
      *** SUMA EL MONTO DE LA NOMINA PARA CALCULO DEL MONTO ESCRITO
      SELECT 2
      STORE BANCO   TO XXBANCO
      STORE 0       TO WCHMONTO
      STORE RECNO() TO WINIREC
      DO WHILE .NOT. EOF() .AND. BANCO = XXBANCO
         STORE WCHMONTO+MONTO TO WCHMONTO
         SKIP
      ENDDO 
      STORE SPACE(50) TO WESCRITO
      STORE WCHMONTO  TO WMONTOESC
      DO MONTOESC
      ***
      SELECT 2
      GO WINIREC       
      IF WTOTBAN>0
         STORE WLINEA+1 TO WLINEA
         @ WLINEA,00 SAY REPLICATE("-",80)
         STORE WLINEA+1 TO WLINEA
         @ WLINEA,00 SAY "TOTAL PARA "+WRUPBAN+" "+WBANDES
         @ WLINEA,67 SAY WTOTBAN   PICTURE "###,###,###.##"      
      ENDIF
      STORE 100   TO WLINEA
      STORE 0     TO WPAGINA
      STORE 0     TO WTOTBAN
      STORE BANCO TO WRUPBAN
      IF WRUPBAN <> SPACE(2)
         SELECT 1
         FIND &WRUPBAN
         IF EOF()
            STORE "NO REGISTRADO" TO WBANDES
         ELSE
            STORE DESCRI          TO WBANDES
         ENDIF
         SELECT 2
      ELSE
         STORE "NO DEFINIDO EN FICHA" TO WBANDES
      ENDIF
      DO COPYDISK
   ENDIF
   SELECT 2
   STORE WLINEA + 1 TO WLINEA
   IF WLINEA >= 55
      STORE WPAGINA+1 TO WPAGINA
      @ 00,00 SAY CHR(14)+QQWW
      @ 01,65 SAY "FECHA :"+DTOC(DATE())
      @ 02,65 SAY "PAGINA:"+STR(WPAGINA,4)
      @ 02,00 SAY "SE"+CHR(165)+"ORES: BANCO "+WBANDES
      *** COLOCA EL NOMBRE DE LA NOMINA SI Y SOLO SI SE PROCESO UNA SOLA NOMINA
      IF WTOTCONT = 1
         @ 03,00 SAY "GRUPO:"+RTRIM(APNOM(1,1))+" --- NOMINA:"+RTRIM(APNOM(1,2))   
      ENDIF
      ***
      @ 06,00 SAY "ESTIMADOS SE"+CHR(165)+"ORES;"
      @ 07,00 SAY "      POR MEDIO DE LA PRESENTE LOS AUTORIZAMOS A CARGAR A NUESTRA CUENTA"
      @ 08,00 SAY "CORRIENTE NUMERO:                     EN ESTA INSTITUCION LA CANTIDAD DE" 
      @ 09,00 SAY LTRIM(WESCRITO)
      @ 11,00 SAY "PARA QUE SEA APLICADO COMO ABONO A NUESTROS SIGUIENTES EMPLEADOS:"
      @ 13,00 SAY "CEDULA"
      @ 13,13 SAY "NOMBRE DEL EMPLEADO"
      @ 13,45 SAY "NRO. DE CUENTA"
      @ 13,67 SAY "MONTO EN BS."
      @ 14,00 SAY "------------"
      @ 14,13 SAY "------------------------------"
      @ 14,45 SAY "--------------------"
      @ 14,67 SAY "--------------"
      STORE 15 TO WLINEA
   ENDIF
   @ WLINEA,00 SAY CEDULA
   STORE SUBSTR(RTRIM(APELLIDOS)+", "+RTRIM(NOMBRES),1,30) TO WNOMBRE
   @ WLINEA,13 SAY WNOMBRE
   @ WLINEA,45 SAY CTABANCO
   @ WLINEA,67 SAY MONTO PICTURE "###,###,###.##"
   STORE WTOTBAN+MONTO TO WTOTBAN
   STORE WTOTREP+MONTO TO WTOTREP
   STORE CTABANCO TO WDISCTA
   STORE MONTO    TO WDISMON
   STORE "C"      TO WDISCD
   *** CARAGA ARCHIVO DE DISCO DE DATOS
   SELECT 4
   DO FILLOC
   APPEND BLANK
   UNLOCK
   DO RECLOC
   REPLACE CUENTA WITH WDISCTA
   REPLACE MONTO  WITH WDISMON
   REPLACE CD     WITH WDISCD
   UNLOCK
   FLUSH
   SELECT 2
   SKIP
ENDDO
IF WTOTBAN>0
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,00 SAY REPLICATE("-",80)
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,00 SAY "TOTAL PARA "+WRUPBAN+" BANCO "+WBANDES
   @ WLINEA,67 SAY WTOTBAN   PICTURE "###,###,###.##"      
ENDIF
STORE WLINEA + 5 TO WLINEA
@ WLINEA,00 SAY "---------------------      ------------------------"
STORE WLINEA + 1 TO WLINEA
@ WLINEA,00 SAY " Lic. Andr‚s Carri¢n         Dip. Hernan Jimenez   "
STORE WLINEA + 1 TO WLINEA
@ WLINEA,00 SAY "    Administrador                  Presidente      "
*** COPIA EL ULTIMO ARCHO A DISCO
STORE BANCO   TO WLASTBAN
STORE WBANDES TO WLASTBANDES
DO COPYDISK
***
SET DEVI TO SCRE
@ 0,0 CLEAR
RESTORE SCRE FROM SCREPRI
CLOSE DATA
CLOSE INDEX
RETURN

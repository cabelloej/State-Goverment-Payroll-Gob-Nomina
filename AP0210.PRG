@ 4,0 CLEAR to 16,79
@ 5,0 TO 16,79
@ 04,00 SAY "NOMINA RESUMEN CONCEPTUAL"
@ 06,2 SAY "TIPO DE PERSONAL       :" 
@ 08,2 SAY "GRUPO                  :"
@ 10,2 SAY "NOMINA                 :"
@ 12,2 SAY "FECHA DE CIERRE (AL)   :"

@ 14,2 SAY "CONCEPTO               :" 
*@ 16,2 SAY "FECHA DE CIERRE FINAL  :"
SAVE SCRE TO SCREPRI
STORE .F. TO WFLAGSCRE
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   IF WFLAGSCRE
      @ 0,0 CLEAR
      RESTORE SCRE FROM SCREPRI
   ELSE
      STORE .T. TO WFLAGSCRE
   ENDIF
   STORE .T. TO WGETTIP
   DO WHILE WGETTIP
      STORE "INDIQUE EL TIPO DE PERSONAL: O=OBREROS, E=EMPLEADOS, J=JUBILADO, P=PENSIONADO" TO MES
      DO MENSAJE WITH MES
      STORE SPACE(1) TO WTIPPER
      @ 06,26 GET WTIPPER PICTURE "!" 
      READ
      IF READKEY()=12.OR.READKEY()=268
         STORE .F. TO WGETTIP
         CLOSE DATA
         CLOSE INDEX
         EXIT
      ENDIF
      IF WTIPPER="E".OR.WTIPPER="O" .OR. WTIPPER='J' .OR. WTIPPER='P'
         EXIT
      ELSE
         STORE "TIPO INVALIDO, VERIFIQUE" TO MES
         DO AVISO WITH MES
      ENDIF
   ENDDO
   IF .NOT. WGETTIP
      EXIT
   ENDIF
   SELECT 1
   USE APGRUPOS INDEX APGRUPOS
   SELECT 2
   USE APNOMINA INDEX APNOMINA
   SELECT 3
   USE APCON INDEX APCON
 
   STORE SPACE(2) TO ZGRUPO
   STORE SPACE(2) TO ZNOMINA
   @ 08,26 GET ZGRUPO
   READ
   IF ZGRUPO <> SPACE(2)
      SELECT 1
      FIND &ZGRUPO
      IF EOF()
         STORE "GRUPO NO REGISTRADO, VERIFIQUE, OPRIMA <ENTER>" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      STORE DESCRI TO WGRUPODES
      @ 08,30 SAY WGRUPODES
      ************************************************************************
      *** SE ESTA PERMITIENDO IMPRIMIR TODAS LAS NOMINAS DE UN GRUPO,        *
      *** PERO HAY QUE CONSIDERAR QUE LAS DIFERENTES NOMINAS DE UN GRUPO     *
      *** PUEDEN TENER DIFERENTES LAPSOS Y FECHAS DE PROCESO QUE NO SABEMOS  *
      *** SI AFECTE LA VERACIDAD DEL INFORME DE NOMINA CONCEPTUAL.           *
      *** POR CONSIGUIENTE, SE RECOMIENDA SOLICITAR NOMINA POR NOMINA.       *
      ************************************************************************
      @ 10,26 GET ZNOMINA
      READ
      IF ZNOMINA <> SPACE(2)
         STORE .F. TO WFLAGNO
         SELECT 2
         STORE ZGRUPO+ZNOMINA TO WCLAVEX
         FIND &WCLAVEX
         IF EOF()
            STORE "NOMINA NO REGISTRADA. VERIFIQUE" TO MES
            DO AVISO WITH MES
            LOOP
         ELSE
            @ 10,30 SAY DESCRI
         ENDIF
         STORE APER2 TO WXAP1
         STORE APER2 TO WXAP2
         @ 12,26 SAY WXAP1
         * @ 14,26 SAY WXAP2
         * IF WXAP2<WXAP1
         *    STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
         *    DO AVISO WITH MES
         *    LOOP
         * ENDIF
         IF ESTADO = 0
            STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
            DO AVISO WITH MES
            LOOP
         ENDIF
      ELSE
      *   STORE "TODAS LAS DEL GRUPO" TO WNOMIDES
      *   @ 10,30 SAY WNOMIDES
      *   SELECT 2
      *   FIND &ZGRUPO
      *   STORE APER2 TO WXAP1
      *   STORE APER2 TO WXAP2
      *   @ 12,26 GET WXAP1
      *   * @ 14,26 GET WXAP2
      *   READ
      *   * IF WXAP2<WXAP1
      *   *    STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
      *   *    DO AVISO WITH MES
      *   *    LOOP
      *   * ENDIF
      *   STORE .F. TO WFLAGNO
      *   DO WHILE .NOT. EOF() .AND. GRUPO = ZGRUPO
      *      IF ESTADO = 0
      *         STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
      *         DO AVISO WITH MES
      *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
      *         DO AVISO WITH MES
      *         STORE .T. TO WFLAGNO
      *         EXIT
      *      ENDIF
      *      IF (APER2>=WXAP1 .AND. APER2<=WXAP2)
      *         *** TODO BIEN
      *      ELSE
      *         STORE "ERROR: NOMINA "+NOMINA+" CON PERIODO DE PAGO FUERA DEL RANGO" TO MES
      *         DO AVISO WITH MES
      *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
      *         DO AVISO WITH MES
      *         STORE .T. TO WFLAGNO
      *         EXIT
      *      ENDIF
      *      SKIP
      *   ENDDO
      *   IF WFLAGNO
      *      LOOP
      *   ENDIF
      LOOP
      ENDIF
   ELSE
      STORE "TODOS LOS GRUPOS"  TO WGRUPODES
      STORE "TODAS LAS NOMINAS" TO WNOMIDES
      STORE CTOD("  -  -  ") TO WXAP1
      STORE CTOD("  -  -  ") TO WXAP2
      @ 08,26 SAY WGRUPODES
      @ 10,26 SAY WNOMIDES
      @ 12,26 GET WXAP1
      * @ 14,26 GET WXAP2
      READ
      * STORE WXAP1 TO WXAP2
      * IF WXAP2<WXAP1
      *    STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
      *    DO AVISO WITH MES
      *    LOOP
      * ENDIF
   ENDIF
   STORE .T. TO WGETCON
   DO WHILE WGETCON
      STORE SPACE(4) TO ZCONCEPTO
      @ 14,26 GET ZCONCEPTO 
      READ
      IF ZCONCEPTO=SPACE(4).OR.READKEY()=12.OR.READKEY()=268
         STORE .F. TO WGETCON
         EXIT
      ENDIF
      SELECT 3
      FIND &ZCONCEPTO
      IF EOF()
         STORE "CONCEPTO NO REGISTRADO, VERIFIQUE" TO MES
         DO AVISO WITH MES
      ELSE
         STORE DESCRI TO WCONCEPDES
         @ 14,32 SAY WCONCEPDES
         EXIT
      ENDIF 
   ENDDO
   IF .NOT. WGETCON
      LOOP
   ENDIF
   STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" TO TEX
   STORE "CR" TO WCH
   DO PREGUNTA
   IF WCH = "R"
      LOOP
   ENDIF
   *** DATOS A TRANSFERIR A APNOMCON
   ***
   STORE "APPAGGEN.DBF" TO QGENFIL
   STORE "APPAGGE1.IDX" TO QGENIDX
   STORE "APPAGCON.DBF" TO QCONFIL
   STORE "APPAGCO2.IDX" TO QCONIDX
   STORE WTIPPER        TO QTIPPER
   STORE ZGRUPO         TO QGRUPO
   STORE ZNOMINA        TO QNOMINA
   STORE WXAP1          TO QDESDE
   STORE WXAP2          TO QHASTA
   STORE ZCONCEPTO      TO QCONCEPTO
   select 2
   do recloc
   replace estado with 7
   unlock
   CLOSE DATA
   CLOSE INDEX
   DO APNOMRES
ENDDO

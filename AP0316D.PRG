@ 04,00 clear to 14,79
@ 05,00 to 14,79
@ 04,00 SAY "HISTORICO NOMINA HORIZONTAL"
@ 06,2 SAY "GRUPO                  :"
@ 08,2 SAY "NOMINA                 :"
@ 10,2 SAY "FECHA DE CIERRE INICIAL:"
@ 12,2 SAY "FECHA DE CIERRE FINAL  :"
SAVE SCRE TO SCREPRI
STORE .F. TO WFLAGSCRE
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   IF WFLAGSCRE
      @ 0,0 CLEAR
      RESTORE SCRE FROM SCREPRI
   ELSE
      STORE .T. TO WFLAGSCRE
   ENDIF
   SELECT 1
   USE APGRUPOS INDEX APGRUPOS
   STORE .T. TO WCARGANDO
   SELECT 2
   USE APNOMINA INDEX APNOMINA
   @ 06,26 GET WGRUPO
   READ
   IF WGRUPO = SPACE(2) .OR.READKEY()=12.OR.READKEY()=268
      CLOSE DATA
      CLOSE INDEX
      EXIT
   ENDIF
   SELECT 1
   FIND &WGRUPO
   IF EOF()
      STORE "GRUPO NO REGISTRADO, VERIFIQUE, OPRIMA <ENTER>" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   STORE DESCRI TO WGRUPODES
   @ 06,30 SAY WGRUPODES
   ************************************************************************
   *** SE ESTA PERMITIENDO IMPRIMIR TODAS LAS NOMINAS DE UN GRUPO,        *
   *** PERO HAY QUE CONSIDERAR QUE LAS DIFERENTES NOMINAS DE UN GRUPO     *
   *** PUEDEN TENER DIFERENTES LAPSOS Y FECHAS DE PROCESO QUE NO SABEMOS  *
   *** SI AFECTE LA VERACIDAD DEL INFORME DE NOMINA VERTICAL .            *
   *** POR CONSIGUIENTE, SE RECOMIENDA SOLICITAR NOMINA POR NOMINA.       *
   ************************************************************************
   @ 08,26 GET WNOMINA
   READ
   IF READKEY()=12.OR.READKEY()=268
      LOOP
   ENDIF
   IF WNOMINA = SPACE(2)
   *   STORE "TODAS LAS DEL GRUPO" TO WNOMIDES
   *   @ 08,30 SAY WNOMIDES
   *   SELECT 2
   *   FIND &WGRUPO
   *   STORE APER2 TO WXAP1
   *   STORE APER2 TO WXAP2
   *   @ 10,26 GET WXAP1
   *   @ 12,26 GET WXAP2
   *   READ
   *   IF WXAP2<WXAP1
   *      STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
   *      DO AVISO WITH MES
   *      LOOP
   *   ENDIF
   *   STORE .F. TO WFLAGNO
   *   DO WHILE .NOT. EOF() .AND. GRUPO = WGRUPO
   *      IF ESTADO = 0
   *         STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
   *         DO AVISO WITH MES
   *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
   *         DO AVISO WITH MES
   *         STORE .T. TO WFLAGNO
   *         EXIT
   *      ENDIF
   *      IF (APER2>=WXAP1 .AND. APER2<=WXAP2)
   *         *** TODO BIEN
   *      ELSE
   *         STORE "ERROR: NOMINA "+NOMINA+" CON PERIODO DE PAGO FUERA DEL RANGO" TO MES
   *         DO AVISO WITH MES
   *         STORE "FAVOR SOLICITAR NOMINA POR NOMINA DEL GRUPO" TO MES
   *         DO AVISO WITH MES
   *         STORE .T. TO WFLAGNO
   *         EXIT
   *      ENDIF
   *      SKIP
   *   ENDDO
   *   IF WFLAGNO
   *      LOOP
   *   ENDIF
       LOOP
   ELSE
      STORE .F. TO WFLAGNO
      SELECT 2
      STORE WGRUPO+WNOMINA TO WCLAVEX
      FIND &WCLAVEX
      IF EOF()
         STORE "NOMINA NO REGISTRADA. VERIFIQUE" TO MES
         DO AVISO WITH MES
         LOOP
      ELSE
         @ 08,30 SAY DESCRI
      ENDIF
      STORE APER2 TO WXAP1
      STORE APER2 TO WXAP2
      @ 10,26 GET WXAP1
      @ 12,26 GET WXAP2
      READ
      IF WXAP2<WXAP1
         STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      IF ESTADO = 0
         STORE "ERROR, NOMINA "+APNOMINA->DESCRI+" ESTA CERRADA" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
   ENDIF
   STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" TO TEX
   STORE "CR" TO WCH
   DO PREGUNTA
   IF WCH = "R"
      LOOP
   ENDIF
   *** DATOS A TRANSFERIR A APNOMVER
   ***
   STORE "APHISGEN.DBF" TO QGENFIL
   STORE "APHISGE3.IDX" TO QGENIDX
   STORE "APHISCON.DBF" TO QCONFIL
   STORE "APHISCO1.IDX" TO QCONIDX
   STORE WGRUPO         TO QGRUPO
   STORE WNOMINA        TO QNOMINA
   STORE WXAP1          TO QDESDE
   STORE WXAP2          TO QHASTA
   CLOSE DATA
   CLOSE INDEX
   sw=0
   DO APNOMHOR
   SET DEVI TO SCRE
ENDDO


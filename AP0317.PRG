@ 4,0 CLEAR to 19,79
@ 5,0 TO 19,79
@ 04,00 SAY "HISTORICO CONCEPTUAL  "
@ 06,2 SAY "TIPO DE PERSONAL       :" 
@ 08,2 SAY "GRUPO                  :"
@ 10,2 SAY "NOMINA                 :"
@ 12,2 SAY "FECHA INICIAL   (DESDE):"
@ 14,2 SAY "FECHA FINAL     (HASTA):"
@ 16,2 SAY "CONCEPTO               :"
@ 18,2 SAY "SALIDA                 :" 
SAVE SCRE TO SCREPRI
STORE .F. TO WFLAGSCRE
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   IF WFLAGSCRE
      @ 0,0 CLEAR
      RESTORE SCRE FROM SCREPRI
   ELSE
      STORE .T. TO WFLAGSCRE
   ENDIF
   STORE .T. TO WGETTIP
   DO WHILE WGETTIP
      STORE "TIPO DE PERS.: O=OBREROS, E=EMPLEADOS, J=JUBILADO, P=PENSIONADO, <ENTER>=AMBOS" TO MES
      DO MENSAJE WITH MES
      STORE SPACE(1) TO WTIPPER
      @ 06,26 GET WTIPPER PICTURE "!" 
      READ
      IF READKEY()=12.OR.READKEY()=268
         STORE .F. TO WGETTIP
         CLOSE DATA
         CLOSE INDEX
         EXIT
      ENDIF
      IF WTIPPER="E".OR.WTIPPER="O".OR. WTIPPER='J' .OR. WTIPPER='P' .OR. WTIPPER=SPACE(1)   
         EXIT
      ELSE
         STORE "TIPO INVALIDO, VERIFIQUE" TO MES
         DO AVISO WITH MES
      ENDIF
   ENDDO
   IF .NOT. WGETTIP
      EXIT
   ENDIF
   SELECT 1
   USE APGRUPOS INDEX APGRUPOS
   SELECT 2
   USE APNOMINA INDEX APNOMINA
   SELECT 3
   USE APCON INDEX APCON
   STORE SPACE(2) TO ZGRUPO
   STORE SPACE(2) TO ZNOMINA
   @ 08,26 GET ZGRUPO
   READ
   IF ZGRUPO <> SPACE(2)
      SELECT 1
      FIND &ZGRUPO
      IF EOF()
         STORE "GRUPO NO REGISTRADO, VERIFIQUE, OPRIMA <ENTER>" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      STORE DESCRI TO WGRUPODES
      @ 08,30 SAY WGRUPODES
      @ 10,26 GET ZNOMINA
      READ
      IF ZNOMINA <> SPACE(2)
         STORE .F. TO WFLAGNO
         SELECT 2
         STORE ZGRUPO+ZNOMINA TO WCLAVEX
         FIND &WCLAVEX
         IF EOF()
            STORE "NOMINA NO REGISTRADA. VERIFIQUE" TO MES
            DO AVISO WITH MES
            LOOP
         ELSE
            @ 10,30 SAY DESCRI
         ENDIF
      ELSE
         STORE "TODAS LAS NOMINAS" TO WNOMIDES
         @ 10,26 SAY WNOMIDES
      ENDIF
   ELSE
      STORE "TODOS LOS GRUPOS"  TO WGRUPODES
      STORE "TODAS LAS NOMINAS" TO WNOMIDES
      @ 08,26 SAY WGRUPODES
      @ 10,26 SAY WNOMIDES
   ENDIF
   STORE CTOD("  -  -  ") TO WXAP1
   STORE CTOD("  -  -  ") TO WXAP2
   @ 12,26 GET WXAP1
   @ 14,26 GET WXAP2
   READ
   IF WXAP2<WXAP1
      STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   STORE .T. TO WGETCON
   DO WHILE WGETCON
      STORE SPACE(4) TO ZCONCEPTO
      @ 16,26 GET ZCONCEPTO 
      READ
      IF ZCONCEPTO=SPACE(4).OR.READKEY()=12.OR.READKEY()=268
         STORE .F. TO WGETCON
         EXIT
      ENDIF
      SELECT 3
      FIND &ZCONCEPTO
      IF EOF()
         STORE "CONCEPTO NO REGISTRADO, VERIFIQUE" TO MES
         DO AVISO WITH MES
      ELSE
         STORE DESCRI TO WCONCEPDES
         @ 16,32 SAY WCONCEPDES
         EXIT
      ENDIF 
   ENDDO
   IF .NOT. WGETCON
      LOOP
   ENDIF
   STORE "SELECCIONE LA SALIDA : (M)ONITOR, (I)MPRESORA" TO TEX
   STORE "MI" TO WCH
   DO PREGUNTA
   STORE WCH TO WSALIDA
   IF WSALIDA = "M"
      STORE 18 TO WSALTO
      STORE "MONITOR" TO WSALIDES
   ELSE
      STORE 55 TO WSALTO
      STORE "IMPRESORA" TO WSALIDES
   ENDIF
   @ 18,26 SAY WSALIDES
   STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" TO TEX
   STORE "CR" TO WCH
   DO PREGUNTA
   IF WCH = "R"
      LOOP
   ENDIF
   STORE "PROCESANDO INFORMACION, FAVOR ESPERAR..." TO MES
   DO MENSAJE WITH MES
   STORE WTIPPER        TO QTIPPER
   STORE ZGRUPO         TO QGRUPO
   STORE ZNOMINA        TO QNOMINA
   STORE WXAP1          TO QDESDE
   STORE WXAP2          TO QHASTA
   STORE ZCONCEPTO      TO QCONCEPTO
   CLOSE DATA
   CLOSE INDEX
   SELECT 1
   USE APHISGEN INDEX APHISGE1
   SELECT 2
   USE APHISCON INDEX APHISCO2
   SELECT 3
   USE APPERSON INDEX APPERSO1
   SELECT 4
   USE APGRUPOS INDEX APGRUPOS
   SELECT 5
   USE APNOMINA INDEX APNOMINA
   SELECT 6
   USE APNOMRES
   COPY STRU TO &WUSERCODE
   SELECT 6
   USE &WUSERCODE
   INDEX ON GRUPO+NOMINA+CEDULA+STR(YEAR(FECHA))+STR(MONTH(FECHA))+STR(DAY(FECHA)) TO &WUSERCODE
   *** APROXIMACION A LA DATA SOLICITADA
   STORE QCONCEPTO TO WCLAVECON
   SELECT 2
   FIND &QCONCEPTO
   IF .NOT. EOF()
      STORE RECNO() TO WSTARTCON
      STORE QCONCEPTO+STR(YEAR(QDESDE)) TO WCLAVECON
      FIND &WCLAVECON
      IF .NOT. EOF()
         STORE RECNO() TO WSTARTCON
         STORE QCONCEPTO+STR(YEAR(QDESDE))+STR(MONTH(QDESDE)) TO WCLAVECON
         FIND &WCLAVECON
         IF .NOT. EOF()
            STORE RECNO() TO WSTARTCON
            STORE QCONCEPTO+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVECON
            FIND &WCLAVECON 
            IF .NOT. EOF()
               STORE RECNO() TO WSTARTCON
            ENDIF
         ENDIF
      ENDIF
   ELSE
      STORE "NO HAY HISTORICOS PARA ESTE CONCEPTO" TO MES
      DO AVISO WITH MES
      LOOP              
   ENDIF
   SELECT 2
   GO WSTARTCON
   DO WHILE .NOT. EOF() .AND. CONCEPTO = QCONCEPTO
      STORE CEDULA TO QCEDULA
      STORE FECHA2 TO QFECHAPAG
      STORE QCEDULA+STR(YEAR(QFECHAPAG))+STR(MONTH(QFECHAPAG))+STR(DAY(QFECHAPAG)) TO WCLAVEGEN 
      SELECT 1
      FIND &WCLAVEGEN
      IF EOF()
         STORE "ERROR, CEDULA :"+QCEDULA+" FECHA:"+DTOC(QFECHA2)+" SIN DATOS GENERALES" TO MES
         DO AVISO WITH MES
         SELECT 2
         SKIP
         LOOP
      ENDIF
      IF QFECHAPAG < QDESDE
         SELECT 2
         SKIP
         LOOP
      ENDIF
      IF QFECHAPAG > QHASTA
         SELECT 2
         EXIT
      ENDIF
      IF QTIPPER <> SPACE(1) .AND. TIPO <> QTIPPER
         SELECT 2
         SKIP 
         LOOP
      ENDIF
      IF QGRUPO <> SPACE(2) .AND. QGRUPO <> GRUPO
         SELECT 2
         SKIP
         LOOP
      ENDIF
      IF QNOMINA <> SPACE(2) .AND. QNOMINA <> NOMINA
         SELECT 2
         SKIP
         LOOP
      ENDIF
      *** FIN DE FILTROS ***
      SELECT 1
      STORE GRUPO     TO WXGRUPO
      STORE NOMINA    TO WXNOMINA
      STORE QCEDULA   TO WXCEDULA
      STORE QFECHAPAG TO WXFECHA
      STORE QCONCEPTO TO WXCONCEPTO
      SELECT 2
      STORE MONTO     TO WXMONTO
      STORE SALDO     TO WXSALDO 
      SELECT 6
      DO FILLOC
      APPEND BLANK
      UNLOCK
      DO RECLOC
      REPLACE GRUPO    WITH WXGRUPO
      REPLACE NOMINA   WITH WXNOMINA
      REPLACE CEDULA   WITH WXCEDULA
      REPLACE FECHA    WITH WXFECHA
      REPLACE MONTO    WITH WXMONTO
      REPLACE SALDO    WITH WXSALDO
      UNLOCK
      SELECT 2
      SKIP
   ENDDO
   CLOSE DATA
   CLOSE INDEX
   ***
   *** INICIO FASE DE EMISION DE RESULTADOS
   ***
   SELECT 1
   USE APGRUPOS   INDEX APGRUPOS
   SELECT 2
   USE APNOMINA   INDEX APNOMINA
   SELECT 3
   USE APPERSON   INDEX APPERSO1
   SELECT 4
   USE &WUSERCODE INDEX &WUSERCODE
   IF WSALIDA = "I"
      SET DEVI  TO PRINT
   ELSE
      @ 0,0 CLEAR
      SET DEVI TO SCRE
   ENDIF
   STORE 0   TO WPAGE
   STORE 100 TO WLINE
   STORE 0   TO WTOTNOM
   STORE 0   TO WTOTGEN
   STORE 0   TO WCONTADOR
   SELECT 4
   GO TOP
   STORE "**" TO WRUPGRUPO
   STORE "**" TO WRUPNOMINA
   DO WHILE .NOT. EOF()
      STORE WLINE+1 TO WLINE
      STORE WCONTADOR + 1 TO WCONTADOR
      *** CHEQUEO DE SALTO DE PAGINA Y/O RUPTURA 
      DO RU0404
      SELECT 4
      IF READKEY()=12.OR.READKEY()=268
         EXIT
      ENDIF
      ***
      STORE CEDULA TO ZCEDULA
      SELECT 3
      FIND &ZCEDULA
      IF EOF()
         STORE "CEDULA NO REGISTRADO" TO ZNOMBRES
      ELSE
         STORE substr( RTRIM(APELLIDOS)+", "+RTRIM(NOMBRES),1,29) TO ZNOMBRES
      ENDIF
      SELECT 4
      @ WLINE,00 SAY WCONTADOR PICTURE "####"      
      @ WLINE,05 SAY CEDULA
      @ WLINE,18 SAY ZNOMBRES
      @ WLINE,49 SAY FECHA
      @ WLINE,58 SAY MONTO PICTURE "#######.##"
      @ WLINE,70 SAY SALDO PICTURE "#######.##" 
      STORE WTOTNOM + MONTO TO WTOTNOM
      STORE WTOTGEN + MONTO TO WTOTGEN
      SELECT 4
      SKIP
   ENDDO
   IF WTOTNOM > 0 
      IF WSALIDA = "M"
         STORE WLINE + 1 TO WLINE
      ELSE
         STORE WLINE + 2 TO WLINE
      ENDIF
      @ WLINE,0  SAY "TOTAL NOMINA"
      @ WLINE,53 SAY WTOTNOM PICTURE "####,###,###.##"
   ENDIF 
   IF WTOTGEN > 0 
      STORE WLINE + 1 TO WLINE
      @ WLINE,0  SAY REPLICATE("-",81)
      STORE WLINE + 1 TO WLINE
      @ WLINE,0  SAY "TOTAL RESUMEN"
      @ WLINE,53 SAY WTOTGEN PICTURE "####,###,###.##"
      STORE 0 TO WTOTNOM
   ENDIF
   IF WSALIDA = "M"
      STORE "OPRIMA <ENTER> PARA FINALIZAR" TO MES
      DO AVISO WITH MES
   ELSE
      SET DEVI TO SCRE
   ENDIF
   CLOSE DATA
   CLOSE INDEX
   DELETE FILE &QAPNOMCON.DBF
   DELETE FILE &QAPNOMCON.IDX
ENDDO   
CLOSE DATA
CLOSE INDEX
RETURN 

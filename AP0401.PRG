*******************************************************************
*               PAGO DE VACACIONES                                *
*******************************************************************
SELECT 1
USE APPERSON INDEX APPERSO1 ALIAS PERSONAL
STORE .T. TO UTIL
DO WHILE UTIL
   @ 5,0 CLEAR TO 14,50
   @ 5,0 TO 14,50 DOUBLE
   STORE "VACACIONES ANUALES" TO HEADING
   @ 5,25-(LEN(HEADING)/2) SAY HEADING
   STORE SPACE(12) TO WCEDULA
   STORE "INGRESE LA CEDULA A PROCESAR" TO MES
   DO MENSAJE WITH MES
   @ 07,5  SAY "CEDULA         :" GET WCEDULA
   @ 08,5  SAY "NOMBRE         :"
   @ 09,5  SAY "FECHA INICIAL  :"
   @ 10,5  SAY "FECHA FINAL    :"
   @ 11,5  SAY "FECHA DE SALIDA:"
   READ
   IF WCEDULA = SPACE(12)
      STORE .F. TO UTIL
      LOOP
   ENDIF
   SELECT PERSONAL
   SEEK WCEDULA
   IF EOF()
      STORE "CEDULA NO REGISTRADA" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   @ 8,22 SAY ALLTRIM(APELLIDOS)+", "+ALLTRIM(NOMBRES)
   STORE SUELDOD   TO WBASICO
   STORE VENCEVAC  TO INIDATE
   STORE INGRESO   TO WINGRESO
   STORE NOMBRES   TO WNOMBRE
   STORE APELLIDOS TO WAPELLIDO
   *STORE ISLR/100 TO WISLR
   *STORE HAB/100  TO WAH
   *STORE SSO/100  TO WSSO
   *STORE SPF/100  TO WSPF
   IF INIDATE = CTOD("  -  -  ")
      STORE WINGRESO TO INIDATE
   ELSE
      STORE INIDATE+1 TO INIDATE
   ENDIF
   IF INIDATE = CTOD("  -  -  ")
      STORE "ESTA PERSONA NO TIENE FECHA DE INGRESO" to mes
      do aviso with mes
      loop
   endif

   STORE "INGRESE LA FECHA INICIAL DEL PERIODO VENCIDO DE LAS VACACIONES" TO MES
   DO MENSAJE WITH MES
   @ 09,22 GET INIDATE
   READ

   STORE DTOC(INIDATE) TO WORKDATE
   store SUBSTR(WORKDATE,1,6) TO FE1
   store SUBSTR(WORKDATE,7,4) TO FE2
   STORE VAL(FE2)+1 TO FE2
   STORE STR(FE2,4) TO FE2
   STORE CTOD(FE1+FE2) TO WFINDATE
   STORE "INGRESE LA FECHA DE CIERRE DEL PERIODO VENCIDO DE LAS VACACIONES" TO MES
   DO MENSAJE WITH MES
   @ 10,22  GET WFINDATE
   READ
   if WFINDATE = CTOD("  -  -  ")
      loop
   endif

   if wfindate < inidate
      store "ERROR, en asignacion de fechas" to mes
      do aviso with mes
      loop
   endif
   STORE CTOD("  -  -  ") TO WFECHASAL
   STORE "INGRESE LA FECHA DE INICIO DEL PERIODO DE DISFRUTE" TO MES
   DO MENSAJE WITH MES
   @ 11,22  GET Wfechasal
   READ
   if wfechasal= CTOD("  -  -  ")
      loop
   endif

   STORE "OPCIONES: (C)ONTINUAR,  (S)ALIR" to TEX
   store "CS" to WCH
   DO PREGUNTA
   if WCH = "S"
      close data
      close index
      return
   endif

   store "Procesando informacion, Favor esperar..." to mes
   do mensaje with mes

   STORE (WFINDATE - INIDATE)/30 TO WMESES
   STORE WMESES - INT(WMESES) TO WFRACCION
   IF WFRACCION >= 0.5
      STORE INT(WMESES)+0.5  TO WMESES
   ELSE
      STORE INT(WMESES)      TO WMESES
   ENDIF

   *** NUMERO DE DIAS DEL PERIODO DE DISFRUTE
   STORE 21 TO WLAPSO

   SELECT 4
   USE APLDT
   LOCATE FOR MESES > WMESES
   IF .NOT. FOUND()
      STORE "ERROR, NO SE ENCONTRO REGISTRO DE MESES A PAGAR :"+STR(WMESES,6,2) TO MES
      DO AVISO WITH MES
      CLOSE DATA
      CLOSE INDEX
      RETURN
   ENDIF
   GO RECNO() - 1
   STORE VACACION TO WDIASVAC
   *STORE 7 + (YEAR(WFECACT)-YEAR(WINGRESO)) TO WBONOVAC
   STORE BONOVAC  TO WBONOVAC
   
   STORE WBASICO             TO Wbasicodia
   store wbasicodia*WDIASVAC TO BSDIASVAC
   STORE WBONOVAC*WBASICODIA TO BSBONOVAC

   STORE DAY(INIDATE)  TO DDDD1
   STORE DAY(WFINDATE) TO DDDD2
   STORE MONTH(INIDATE) TO MMMM1
   STORE MONTH(WFINDATE) TO MMMM2

   store WFechasal + wlapso to wfechaven
   STORE 0 TO ADICIONAL
   STORE 0 TO FERIADO
   SELECT 5
   USE APHOLLY
   DO WHILE .NOT. EOF()
      STORE wfechasal TO F1
      STORE wfechaven TO F2
      STORE 0 TO NUMDIA
      DO WHILE F1<=F2
         STORE NUMDIA + 1 TO NUMDIA
         IF DAY(F1) = DAY(FECHA) .AND. MONTH(F1) = MONTH(FECHA)
            STORE FERIADO + 1 TO FERIADO
            STORE F2 TO F1
            IF NUMDIA <= 15
               STORE ADICIONAL + 1 TO ADICIONAL
            ENDIF
         ENDIF
         STORE F1+1 TO F1
      ENDDO
      SKIP
   ENDDO
   STORE WBASICODIA*FERIADO TO BSFERIADO
   STORE WLAPSO+FERIADO TO WDIASDISF

   *STORE (BSDIASVAC+BSBONOVAC+BSFERIADO)*wislr to WBSISLR
   *STORE (WLAPSO*WBASICODIA)*wsso              to WBSSSO
   *STORE (WLAPSO*WBASICODIA)*wsPF              to WBSSPF
   *STORE (WLAPSO*WBASICODIA)*wAH               to WBSAH
   set devi to print
   @ 1,0 SAY CHR(14)+QQWW+CHR(18)
   @ 2,60 SAY "FECHA :"+DTOC(date())
   @ 4,30 SAY "VACACIONES ANUALES"
   @ 5,1 SAY "NOMBRE: "+RTRIM(WAPELLIDO)+", "+WNOMBRE
   @ 5,60 SAY "CEDULA: "+WCEDULA
   @ 7,1 SAY "DIARIO: "+STR(Wbasico,8,2)
   @ 9,1  SAY "PERIODO VENCIDO :  DEL "+DTOC(INIDATE)+" AL "+DTOC(WFINDATE)
   @ 9,60 SAY "MESES : "+WMESES
   @ 10,1  SAY "PERIODO DISFRUTE:  DEL "+DTOC(WFECHASAL)+" AL "+DTOC(WFECHAVEN)
   *@ 12,1 SAY "DESCRIPCION                      CANT.   ASIGNACION      DEDUCION       SALDO"
   @ 12,1 SAY "DESCRIPCION                      CANT.        MONTO"
   @ 13,1 SAY "----------------------------     -----   ----------"
   *@ 13,1 SAY "----------------------------     -----   ----------   -----------  ----------"
   @ 14,1 SAY "VACACIONES ANUALES"
   @ 14,30 SAY STR(WDIASVAC,8,2)
   @ 14,40 SAY STR(BSDIASVAC,12,2)
   @ 16,1 SAY "FERIADOS PERIODO DISFRUTE"
   @ 16,30 SAY STR(FERIADO,8,2)
   @ 16,40 SAY STR(BSFERIADO,12,2)
   @ 18,1 SAY "BONO VACACIONAL"
   @ 18,30 SAY STR(WBONOVAC,8,2)
   @ 18,40 SAY STR(BSBONOVAC,12,2)

   *@ 20,1 SAY "IMPUESTO SOBRE LA RESTA"
   *@ 20,54 SAY STR(WBSISLR,12,2)
   *@ 22,1 SAY "SEGURO SOCIAL OBLIGATORIO"
   *@ 22,54 SAY STR(WBSSSO,12,2)
   *@ 24,1 SAY "SEGURO DE PARO FORZOSO"
   *@ 24,54 SAY STR(WBSSPF,12,2)
   *@ 26,1 SAY "AHORRO HABITACIONAL"
   *@ 26,54 SAY STR(WBSAH,12,2)
   *@ 28,1 SAY "SINDICATOS"
   *@ 28,54 SAY STR(WBSSINDIC,12,2)
   
   STORE (BSDIASVAC+BSFERIADO+BSBONOVAC) TO WTOTASIG
   *STORE (WBSISLR+WBSSSO+WBSSPF+WBSAH)  TO WTOTDEC
   *STORE WTOTASIG-WTOTDEC TO WMONTO
   @ 20,1 SAY "T O T A L E S  "
   @ 20,40 SAY STR(WTOTASIG,12,2)
   *@ 20,54 SAY STR(WTOTDEC,12,2)
   *@ 20,67 SAY STR(WMONTO,12,2)
   @ 24,40 say "__________________________________"
   @ 25,40 say "      Firma del trabajador"
   @ 27,3 say "____________________________"
   @ 28,3 say "  Lugar y Fecha del Pago    "
   EJECT
   SELECT 1
   REPLACE VENCEVAC WITH WFINDATE
   SET DEVI TO SCRE
ENDDO
CLOSE DATA
CLOSE INDEX
RETURN


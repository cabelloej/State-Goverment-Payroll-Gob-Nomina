@ 4,0 CLEAR to 16,79
@ 5,0 TO 16,79
@ 04,00 SAY "   AHORRO HABITACIONAL  "
@ 06,02 SAY "TIPO DE PERSONAL       :" 
@ 08,02 SAY "GRUPO                  :"
@ 10,02 SAY "NOMINA                 :"
@ 12,02 SAY "DESDE EL A"+CHR(165)+"O Y MES     :"
@ 14,02 SAY "HASTA EL A"+CHR(165)+"O Y MES     :"
SAVE SCRE TO SCREPRI
STORE .F. TO WFLAGSCRE
STORE .T. TO WCARGANDO
DO WHILE WCARGANDO
   IF WFLAGSCRE
      @ 0,0 CLEAR
      RESTORE SCRE FROM SCREPRI
   ELSE
      STORE .T. TO WFLAGSCRE
   ENDIF
   STORE .T. TO WGETTIP
   DO WHILE WGETTIP
      STORE "TIPO DE PERSONAL: O=OBREROS, E=EMPLEADOS, <ENTER>=AMBOS" TO MES
      DO MENSAJE WITH MES
      STORE SPACE(1) TO ZTIPPER
      @ 06,26 GET ZTIPPER PICTURE "!" 
      READ
      IF READKEY()=12.OR.READKEY()=268
         STORE .F. TO WGETTIP
         CLOSE DATA
         CLOSE INDEX
         EXIT
      ENDIF
      IF ZTIPPER="E".OR.ZTIPPER="O".OR.ZTIPPER=" "   
         EXIT
      ELSE
         STORE "TIPO INVALIDO, VERIFIQUE" TO MES
         DO AVISO WITH MES
      ENDIF
   ENDDO
   IF .NOT. WGETTIP
      EXIT
   ENDIF
   SELECT 1
   USE APGRUPOS INDEX APGRUPOS
   SELECT 2
   USE APNOMINA INDEX APNOMINA
   STORE SPACE(2) TO ZGRUPO
   STORE SPACE(2) TO ZNOMINA
   @ 08,26 GET ZGRUPO
   READ
   IF ZGRUPO <> SPACE(2)
      SELECT 1
      FIND &ZGRUPO
      IF EOF()
         STORE "GRUPO NO REGISTRADO, VERIFIQUE, OPRIMA <ENTER>" TO MES
         DO AVISO WITH MES
         LOOP
      ENDIF
      STORE DESCRI TO WGRUPODES
      @ 08,30 SAY WGRUPODES
      @ 10,26 GET ZNOMINA
      READ
      IF ZNOMINA <> SPACE(2)
         STORE .F. TO WFLAGNO
         SELECT 2
         STORE ZGRUPO+ZNOMINA TO WCLAVEX
         FIND &WCLAVEX
         IF EOF()
            STORE "NOMINA NO REGISTRADA. VERIFIQUE" TO MES
            DO AVISO WITH MES
            LOOP
         ELSE
            @ 10,30 SAY DESCRI
            STORE DESCRI TO WNOMIDES
         ENDIF
      ELSE
         STORE "TODAS LAS DEL GRUPO" TO WNOMIDES
         @ 10,30 SAY WNOMIDES
      ENDIF
   ELSE
      STORE "TODOS LOS GRUPOS"  TO WGRUPODES
      STORE "TODAS LAS NOMINAS" TO WNOMIDES
      STORE CTOD("  -  -  ") TO WXAP1
      STORE CTOD("  -  -  ") TO WXAP2
      @ 08,26 SAY WGRUPODES
      @ 10,26 SAY WNOMIDES
   ENDIF
   STORE YEAR(DATE())  TO WY1
   STORE YEAR(DATE())  TO WY2
   STORE MONTH(DATE()) TO WM1
   STORE MONTH(DATE()) TO WM2
   @ 12,26 GET WY1 PICTURE "####" RANGE 1994, 3000
   @ 12,31 GET WM1 PICTURE "##"   RANGE 1,12
   READ
   @ 14,26 GET WY2 PICTURE "####" RANGE 1994, 3000
   @ 14,31 GET WM2 PICTURE "##"   RANGE 1,12
   READ
   IF WY2<WY1
      STORE "ERROR EN FECHAS, VERIFIQUE." TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" TO TEX
   STORE "CR" TO WCH
   DO PREGUNTA
   IF WCH = "R"
      LOOP
   ENDIF
   CLOSE DATA
   CLOSE INDEX
   SELECT 1
   USE APHISGEN INDEX APHISGE1
   SELECT 2
   USE APHISCON INDEX APHISCO2
   SELECT 3
   USE APPERSON INDEX APPERSO1
   SELECT 4
   USE APGRUPOS INDEX APGRUPOS
   SELECT 5
   USE APNOMINA INDEX APNOMINA
   SELECT 6
   USE APNOMRES
   COPY STRU TO &WUSERCODE
   SELECT 6
   USE &WUSERCODE
   INDEX ON GRUPO+NOMINA+CEDULA+STR(YEAR(FECHA))+STR(MONTH(FECHA))+STR(DAY(FECHA)) TO &WUSERCODE
   
STORE QCONCEPTO+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVECON 
SELECT 2
FIND &WCLAVECON
DO WHILE .NOT. EOF() .AND. CONCEPTO = QCONCEPTO
   STORE CEDULA TO QCEDULA
   STORE FECHA2 TO QFECHA2
   IF QFECHA2>=QDESDE.AND.QFECHA2<=QHASTA
      *** PASA BIEN
   ELSE
      EXIT
   ENDIF
   STORE QCEDULA+STR(YEAR(QFECHA2))+STR(MONTH(QFECHA2))+STR(DAY(QFECHA2)) TO WCLAVEPER 
   SELECT 1
   FIND &WCLAVEPER
   IF EOF()
      STORE "ERROR, CEDULA :"+QCEDULA+" FECHA:"+DTOC(QFECHA2)+" SIN DATOS GENERALES" TO MES
      DO AVISO WITH MES
      SELECT 2
      SKIP
      LOOP
   ENDIF
   IF TIPO <> QTIPPER
      SELECT 2
      SKIP 
      LOOP
   ENDIF
   IF QGRUPO <> SPACE(2) .AND. QGRUPO <> GRUPO
      SELECT 2
      SKIP
      LOOP
   ENDIF
   IF QNOMINA <> SPACE(2) .AND. QNOMINA <> NOMINA
      SELECT 2
      SKIP
      LOOP
   ENDIF
   *** FIN DE FILTROS ***
   SELECT 1
   STORE GRUPO     TO WXGRUPO
   STORE NOMINA    TO WXNOMINA
   STORE QCEDULA   TO WXCEDULA
   STORE QFECHA2   TO WXFECHA
   STORE QCONCEPTO TO WXCONCEPTO
   SELECT 2
   STORE MONTO     TO WXMONTO
   STORE SALDO     TO WXSALDO 
   SELECT 6
   DO FILLOC
   APPEND BLANK
   UNLOCK
   DO RECLOC
   REPLACE GRUPO    WITH WXGRUPO
   REPLACE NOMINA   WITH WXNOMINA
   REPLACE CEDULA   WITH WXCEDULA
   REPLACE FECHA    WITH WXFECHA
   REPLACE MONTO    WITH WXMONTO
   REPLACE SALDO    WITH WXSALDO
   UNLOCK
   SELECT 2
   SKIP
ENDDO
CLOSE DATA
CLOSE INDEX
***
*** INICIO FASE DE EMISION DE RESULTADOS
***
SELECT 1
USE APGRUPOS   INDEX APGRUPOS
SELECT 2
USE APNOMINA   INDEX APNOMINA
SELECT 3
USE APPERSON   INDEX APPERSO1
SELECT 4
USE &WUSERCODE INDEX &WUSERCODE
SET DEVI  TO PRINT
STORE 0   TO WPAGE
STORE 100 TO WLINE
STORE 0   TO WTOTNOM
STORE 0   TO WTOTGEN
STORE 0   TO WCONTADOR
SELECT 4
GO TOP
STORE "**" TO WRUPGRUPO
STORE "**" TO WRUPNOMINA
DO WHILE .NOT. EOF()
   STORE WLINE+1 TO WLINE
   STORE WCONTADOR + 1 TO WCONTADOR
   *** CHEQUEO DE SALTO DE PAGINA Y/O RUPTURA 
   DO RUNOMRES
   SELECT 4
   ***
   STORE CEDULA TO ZCEDULA
   SELECT 3
   FIND &ZCEDULA
   IF EOF()
      STORE "CEDULA NO REGISTRADO" TO ZNOMBRES
   ELSE
      STORE RTRIM(APELLIDOS)+" "+RTRIM(NOMBRES) TO ZNOMBRES
   ENDIF
   SELECT 4
   @ WLINE,00 SAY WCONTADOR PICTURE "####"      
   @ WLINE,05 SAY CEDULA
   @ WLINE,18 SAY ZNOMBRES
   @ WLINE,49 SAY FECHA
   @ WLINE,58 SAY MONTO PICTURE "#######.##"
   @ WLINE,71 SAY SALDO PICTURE "#######.##" 
   STORE WTOTNOM + MONTO TO WTOTNOM
   STORE WTOTGEN + MONTO TO WTOTGEN
   SELECT 4
   SKIP
ENDDO
IF WTOTNOM > 0 
   STORE WLINE + 2 TO WLINE
   @ WLINE,0  SAY "TOTAL NOMINA"
   @ WLINE,53 SAY WTOTNOM PICTURE "####,###,###.##"
ENDIF 
IF WTOTGEN > 0 
   STORE WLINE + 1 TO WLINE
   @ WLINE,0  SAY REPLICATE("-",81)
   STORE WLINE + 1 TO WLINE
   @ WLINE,0  SAY "TOTAL RESUMEN"
   @ WLINE,53 SAY WTOTGEN PICTURE "####,###,###.##"
   STORE 0 TO WTOTNOM
ENDIF 
EJECT
SET DEVI TO SCRE
CLOSE DATA
CLOSE INDEX
DELETE FILE &QAPNOMCON.DBF
DELETE FILE &QAPNOMCON.IDX
RETURN
enddo

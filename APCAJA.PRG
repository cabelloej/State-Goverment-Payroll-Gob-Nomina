* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE2.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO1.IDX" TO QCONIDX  . /
* STORE WGRUPO         TO QGRUPO
* STORE WNOMINA        TO QNOMINA
* STORE WF1            TO QDESDE
* STORE WF2            TO QHASTA

STORE "2005" TO WCODAPOR
STORE "2010" TO WCODADIC
STORE "2015" TO WCODPRES

SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APCAJA
COPY STRU TO &WUSERCODE
USE &WUSERCODE
INDEX ON CEDULA TO &WUSERCODE
SELECT 4
USE APPERSON INDEX APPERSO1
SELECT 5
USE APNOMINA INDEX APNOMINA

SET DEVI TO PRINT
STORE "**"  TO WRUPGRUPO
STORE "**"  TO WRUPNOMINA
STORE "**"  TO WRUPDIRE
STORE "**"  TO WRUPDEPA
STORE "***" TO WRUPSECC
STORE 100 TO WLINE
STORE 0   TO WPAGINA
SELECT 5
FIND &QGRUPO
DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO
   IF QNOMINA <> SPACE(2) .AND. NOMINA <> QNOMINA
      SELECT 5
      SKIP
      LOOP
   ENDIF
   STORE NOMINA TO QQNOMINA
   STORE DESCRI TO WNOMIDES
   SELECT 1
   STORE QGRUPO+QQNOMINA+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVE1
   FIND &WCLAVE1
   IF EOF()
      STORE "ERROR, NO HAY INFORMACION PARA NOMINA:"+QQNOMINA+" EN ESTA FECHA DE CIERRE" TO MES
      DO AVISO WITH MES
      STORE "RECOMENDAMOS SOLICITAR NOMINA POR NOMINA, OPRIMA <ENTER>." TO MES
      DO AVISO WITH MES
      EXIT
   ENDIF
   DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO .AND. NOMINA = QQNOMINA .AND. FECHA2 >=QDESDE .AND. FECHA2 <=QHASTA
      STORE CEDULA  TO  XCEDULA
      STORE FECHA1  TO  XFECHA1
      STORE FECHA2  TO  XFECHA2
      STORE GRUPO   TO  XGRUPO
      STORE NOMINA  TO  XNOMINA
      STORE TIPO    TO  XTIPO
      STORE FECHA2  TO  XFECHA
      ***
      STORE 0 TO WPERAPOR
      STORE 0 TO WPERADIC
      STORE 0 TO WPERPRES
      STORE XCEDULA+STR(YEAR(XFECHA))+STR(MONTH(XFECHA))+STR(DAY(XFECHA)) TO WCLAVE2
      *** AHORRO
      SELECT 2
      SEEK WCLAVE2+WCODAPOR
      IF FOUND()
         STORE MONTO TO XMONTO
         SELECT 3
         SEEK XCEDULA
         IF .NOT. FOUND()
            DO FILLOC
            APPEND BLANK
            REPLACE CEDULA    WITH XCEDULA
            UNLOCK ALL
         ENDIF
         DO RECLOC
         REPLACE AHORRO    WITH AHORRO+XMONTO
         UNLOCK
      ENDIF
      *** ADICIONAL
      SELECT 2
      SEEK WCLAVE2+WCODADIC
      IF FOUND()
         STORE MONTO TO XMONTO
         SELECT 3
         SEEK XCEDULA
         IF .NOT. FOUND()
            DO FILLOC
            APPEND BLANK
            REPLACE CEDULA    WITH XCEDULA
            UNLOCK ALL
         ENDIF
         DO RECLOC
         REPLACE ADICIONAL    WITH ADICIONAL+XMONTO
         UNLOCK
      ENDIF
      *** PRESTAMO
      SELECT 2
      SEEK WCLAVE2+WCODPRES
      IF FOUND()
         STORE MONTO TO XMONTO
         SELECT 3
         SEEK XCEDULA
         IF .NOT. FOUND()
            DO FILLOC
            APPEND BLANK
            REPLACE CEDULA    WITH XCEDULA
            UNLOCK ALL
         ENDIF
         DO RECLOC
         REPLACE PRESTAMO     WITH PRESTAMO+XMONTO
         UNLOCK
      ENDIF
      ***
      SELECT 1
      SKIP
   ENDDO
   UNLOCK
   SELECT 5
   SKIP
ENDDO
SELECT 3
SET DEVI  TO PRINT
@ PROW(), PCOL() SAY CHR(18)
STORE 100 TO WLINE
STORE 0   TO WPAGINA
STORE 0   TO WPERSONAS
STORE 0   TO WTOTCAJ
STORE 0   TO WTOTASA
STORE 0   TO WTOTADI
STORE 0   TO WTOTPRE
STORE 0   TO WTOTTOT

SELECT 3
GO TOP
DO WHILE .NOT. EOF()
   STORE WPERSONAS+1 TO WPERSONAS
   STORE CEDULA TO WCEDULA
   SELECT 4
   SEEK WCEDULA
   IF FOUND()
      STORE CTACAJA                              TO WCTACAJA
      STORE RTRIM(APELLIDOS)+", "+RTRIM(NOMBRES) TO WNOMBRE
   ELSE
      STORE "NO REGISTRADO" TO WNOMBRE
      STORE SPACE(1)        TO WCTACAJA
   ENDIF
   SELECT 3
   STORE ROUND(AHORRO*1.5,2) TO WAPORTE
   STORE AHORRO+WAPORTE+ADICIONAL+PRESTAMO TO WTOTPER
   STORE WTOTCAJ+AHORRO    TO WTOTCAJ
   STORE WTOTASA+WAPORTE   TO WTOTASA
   STORE WTOTADI+ADICIONAL TO WTOTADI
   STORE WTOTPRE+PRESTAMO  TO WTOTPRE
   STORE WTOTTOT+WTOTPER   TO WTOTTOT
   STORE WLINE+1 TO WLINE
   IF WLINE>55
      DO HDCAJA
   ENDIF
   @ WLINE,00  SAY SUBSTR(WNOMBRE,1,34)
   @ WLINE,35  SAY CEDULA
   @ WLINE,50  SAY WCTACAJA
   IF WSOLO="N"
      @ WLINE,73  SAY AHORRO
   ENDIF
   @ WLINE,86  SAY WAPORTE
   IF WSOLO="N"
      @ WLINE,99  SAY ADICIONAL
      @ WLINE,112 SAY PRESTAMO
      @ WLINE,125 SAY WTOTPER
   ENDIF
   SELECT 3
   SKIP
ENDDO
STORE WLINE+1 TO WLINE
@ WLINE,00  SAY REPLICATE("=",138)
STORE WLINE+1 TO WLINE
@ WLINE,00 SAY "TOTAL PERSONAS:"+STR(WPERSONAS,5)
IF WSOLO="N"
   @ WLINE,73  SAY WTOTCAJ
ENDIF
@ WLINE,86  SAY WTOTASA
IF WSOLO="N"
   @ WLINE,99  SAY WTOTADI
   @ WLINE,112 SAY WTOTPRE
   @ WLINE,125 SAY WTOTTOT
ENDIF
SET DEVI TO SCRE
EJECT
CLOSE DATA
CLOSE INDEX
RETURN

*************
PROC HDCAJA
*************
STORE WPAGINA+1 TO WPAGINA
@ 00,00  SAY CHR(18)
@ 01,00  SAY CHR(14)+QQWW
@ 02,60  SAY "Fecha :"
@ 02,67  SAY date()
@ 03,60  SAY "Pagina:"
@ 03,67  SAY str(wpagina,2)
@ 03,00  SAY "INFORME DE CAJA DE AHORROS"
@ 04,00  SAY "NOMINA :"+WNOMIDES
@ 05,00  SAY "DESDE EL CORTE DEL :"
@ 05,21  SAY QDESDE
@ 06,00  SAY "HASTA EL CORTE DEL :"
@ 06,21  SAY QDESDE
@ 06,00  SAY CHR(15)
@ 07,00  SAY "APELLIDOS Y NOMBRES"
@ 07,35  SAY "No. CEDULA"
@ 07,50  SAY "No. CUENTA"
IF WSOLO="N"
   @ 07,82  SAY "AHORRO"
ENDIF
@ 07,93  SAY "APORTE"
IF WSOLO="N"
   @ 07,102 SAY "AHORRO"
   @ 07,119 SAY "ABONO"
   @ 07,131 SAY "TOTAL A"
   @ 08,81  SAY "CAJA"
ENDIF
@ 08,92  SAY "ASAMBLA"
IF WSOLO="N"
   @ 08,102 SAY "ADICIONAL"
   @ 08,116 SAY "PRESTAMO"
   @ 08,129 SAY "DEPOSITAR"
ENDIF
@ 09,00  SAY REPLICATE("=",138)
STORE 10 TO WLINE
RETURN

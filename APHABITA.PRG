* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE2.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO1.IDX" TO QCONIDX  . /
* STORE WGRUPO         TO QGRUPO
* STORE WNOMINA        TO QNOMINA
* STORE WF1            TO QDESDE
* STORE WF2            TO QHASTA

STORE "2055" TO WCODAPOR

SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APHABITA
COPY STRU TO &WUSERCODE
USE &WUSERCODE
INDEX ON CEDULA TO &WUSERCODE
SELECT 4
USE APPERSON INDEX APPERSO1
SELECT 5
USE APNOMINA INDEX APNOMINA

SELECT 5
FIND &QGRUPO
DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO
   IF QNOMINA <> SPACE(2) .AND. NOMINA <> QNOMINA
      SELECT 5
      SKIP
      LOOP
   ENDIF
   STORE NOMINA TO QQNOMINA
   STORE DESCRI TO WNOMIDES
   SELECT 1
   STORE QGRUPO+QQNOMINA+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVE1
   FIND &WCLAVE1
   IF EOF()
      STORE "ERROR, NO HAY INFORMACION PARA NOMINA:"+QQNOMINA+" EN ESTA FECHA DE CIERRE" TO MES
      DO AVISO WITH MES
      STORE "RECOMENDAMOS SOLICITAR NOMINA POR NOMINA, OPRIMA <ENTER>." TO MES
      DO AVISO WITH MES
      EXIT
   ENDIF
   DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO .AND. NOMINA = QQNOMINA .AND. FECHA2 >=QDESDE .AND. FECHA2 <=QHASTA
      STORE CEDULA  TO  XCEDULA
      STORE FECHA1  TO  XFECHA1
      STORE FECHA2  TO  XFECHA2
      STORE GRUPO   TO  XGRUPO
      STORE NOMINA  TO  XNOMINA
      STORE TIPO    TO  XTIPO
      STORE FECHA2  TO  XFECHA
      ***
      STORE XCEDULA+STR(YEAR(XFECHA))+STR(MONTH(XFECHA))+STR(DAY(XFECHA)) TO WCLAVE2
      *** AHORRO HAB.
      SELECT 2
      SEEK WCLAVE2+WCODAPOR
      IF FOUND()
         STORE MONTO TO XMONTO
         SELECT 3
         SEEK XCEDULA
         IF .NOT. FOUND()
            DO FILLOC
            APPEND BLANK
            REPLACE CEDULA    WITH XCEDULA
            UNLOCK ALL
         ENDIF
         DO RECLOC
         REPLACE AHORRO    WITH AHORRO+XMONTO
         UNLOCK
      ENDIF
      SELECT 1
      SKIP
   ENDDO
   UNLOCK
   SKIP
ENDDO
***
SET DEVI  TO PRINT
@ PROW(), PCOL() SAY CHR(18)
STORE 100 TO WLINE
STORE 0   TO WPAGINA
STORE 0   TO WPERSONAS
STORE 0   TO WTOTAHO
STORE 0   TO WTOTASA
STORE 0   TO WTOTTOT
SELECT 3
GO TOP
DO WHILE .NOT. EOF()
   STORE WPERSONAS+1 TO WPERSONAS
   STORE CEDULA TO WCEDULA
   SELECT 4
   SEEK WCEDULA
   IF FOUND()
     *STORE CTAHABITA                            TO WCTAHABIT
      STORE RTRIM(APELLIDOS)+", "+RTRIM(NOMBRES) TO WNOMBRE
   ELSE
      STORE "NO REGISTRADO" TO WNOMBRE
      STORE SPACE(1)        TO WCTAHABIT
   ENDIF
   SELECT 3
   STORE ROUND(AHORRO*2,2) TO WAPORTE
   STORE AHORRO+WAPORTE    TO WTOTPER
   STORE WTOTAHO+AHORRO    TO WTOTAHO
   STORE WTOTASA+WAPORTE   TO WTOTASA
   STORE WTOTTOT+WTOTPER   TO WTOTTOT
   STORE WLINE+1 TO WLINE
   IF WLINE>55
      DO HDAHORRO
   ENDIF
   @ WLINE,00  SAY SUBSTR(WNOMBRE,1,34)
   @ WLINE,35  SAY CEDULA
  *@ WLINE,50  SAY WCTAAHO
   IF WSOLO="N"
      @ WLINE,73  SAY AHORRO
   ENDIF
   @ WLINE,86  SAY WAPORTE
   IF WSOLO="N"
      @ WLINE,99 SAY WTOTPER
   ENDIF
   SELECT 3
   SKIP
ENDDO
STORE WLINE+1 TO WLINE
@ WLINE,00  SAY REPLICATE("=",138)
STORE WLINE+1 TO WLINE
@ WLINE,00 SAY "TOTAL PERSONAS:"+STR(WPERSONAS,5)
IF WSOLO="N"
   @ WLINE,73  SAY WTOTAHO
ENDIF
@ WLINE,86  SAY WTOTASA
IF WSOLO="N"
   @ WLINE,99  SAY WTOTTOT
ENDIF
SET DEVI TO SCRE
EJECT
CLOSE DATA
CLOSE INDEX
RETURN

*************
PROC HDAHORRO
*************
STORE WPAGINA+1 TO WPAGINA
@ 00,00  SAY CHR(18)
@ 01,00  SAY CHR(14)+QQWW
@ 02,60  SAY "Fecha :"
@ 02,67  SAY date()
@ 03,60  SAY "Pagina:"
@ 03,67  SAY str(wpagina,2)
@ 03,00  SAY "INFORME DE AHORRO HABITACIONAL"
@ 04,00  SAY "NOMINA :"+WNOMIDES
@ 05,00  SAY "DESDE EL CORTE DEL :"
@ 05,21  SAY QDESDE
@ 06,00  SAY "HASTA EL CORTE DEL :"
@ 06,21  SAY QDESDE
@ 06,00  SAY CHR(15)
@ 07,00  SAY "APELLIDOS Y NOMBRES"
@ 07,35  SAY "No. CEDULA"
@ 07,50  SAY "No. CUENTA"
IF WSOLO="N"
   @ 07,73  SAY "      AHORRO"
ENDIF
@ 07,86  SAY "      APORTE"
IF WSOLO="N"
   @ 07,99  SAY "       TOTAL"
ENDIF
@ 08,00  SAY REPLICATE("=",138)
STORE 9 TO WLINE
RETURN

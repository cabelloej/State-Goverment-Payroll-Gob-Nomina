* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE2.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO1.IDX" TO QCONIDX  . /
* STORE WGRUPO         TO QGRUPO
* STORE WNOMINA        TO QNOMINA
* STORE WF1            TO QDESDE
* STORE WF2            TO QHASTA

SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APCON INDEX APCON
SELECT 4
USE APPERSON INDEX APPERSO1
SELECT 5
USE APNOMINA INDEX APNOMINA
SELECT 6
USE &WUSERCODE INDEX &WUSERBAN1, &WUSERBAN2
SELECT 5
FIND &QGRUPO
DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO
   IF QNOMINA <> SPACE(2) .AND. NOMINA <> QNOMINA
      SELECT 5
      SKIP
      LOOP
   ENDIF
   STORE NOMINA TO QQNOMINA
   STORE DESCRI TO WNOMIDES
   SELECT 1
   STORE QGRUPO+QQNOMINA+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVE1
   FIND &WCLAVE1
   IF EOF()
      STORE "ERROR, NO HAY INFORMACION PARA NOMINA:"+QQNOMINA+" EN ESTA FECHA DE CIERRE" TO MES
      DO AVISO WITH MES
      STORE "RECOMENDAMOS SOLICITAR NOMINA POR NOMINA, OPRIMA <ENTER>." TO MES
      DO AVISO WITH MES
      EXIT
   ENDIF
   DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO .AND. NOMINA = QQNOMINA  FECHA2 >=QDESDE .AND. FECHA2 <=QHASTA
      STORE CEDULA  TO  XCEDULA
      STORE FECHA1  TO  XFECHA1
      STORE FECHA2  TO  XFECHA2
      STORE GRUPO   TO  XGRUPO
      STORE NOMINA  TO  XNOMINA
      STORE DIRE    TO  XDIRE
      STORE DEPA    TO  XDEPA
      STORE SECC    TO  XSECC
      STORE CARGO   TO  XCARGO
      STORE SUELDOH TO  XSUELDOH
      STORE SUELDOD TO  XSUELDOD
      STORE SUELDOP TO  XSUELDOP
      STORE TIPO    TO  XTIPO
      STORE FECHA2  TO  XFECHA
      STORE 100     TO WLINE
      STORE 0       TO WTOTASI
      STORE 0       TO WTOTBON
      STORE 0       TO WTOTNBON
      STORE 0       TO WTOTDEC
      STORE 0       TO WTOTLIQ
      STORE XCEDULA+STR(YEAR(XFECHA))+STR(MONTH(XFECHA))+STR(DAY(XFECHA)) TO WCLAVE2
      SELECT 2
      FIND &WCLAVE2
      DO WHILE .NOT. EOF() .AND. CEDULA=XCEDULA .AND. FECHA2=XFECHA
         STORE CONCEPTO TO XCONCEPTO
         STORE MONTO    TO XMONTO
         SELECT 3
         FIND &XCONCEPTO
         IF EOF()
            STORE .F.             TO XFLAGCON
         ELSE
            STORE .T.             TO XFLAGCON
         ENDIF
         SELECT 4
         FIND &XCEDULA
         IF EOF()
            STORE "**"            TO XBANCO
            STORE "************"  TO XCTABANCO
         ELSE
            STORE NOMBRES         TO XNOMBRES
            STORE APELLIDOS       TO XAPELLIDOS
            STORE BANCO           TO XBANCO
            STORE CTABANCO        TO XCTABANCO
         ENDIF
         SELECT 2
         IF XFLAGCON
            DO TOTALIZA
         ENDIF
         SELECT 2
         SKIP
      ENDDO
      IF WTOTLIQ > 0
         SELECT 6
         FIND &XCEDULA
         IF EOF()
            DO FILLOC
            APPEND BLANK
            UNLOCK 
            DO RECLOC
            REPLACE CEDULA WITH XCEDULA
         ENDIF
         DO RECLOC
         REPLACE NOMBRES   WITH XNOMBRES
         REPLACE APELLIDOS WITH XAPELLIDOS
         REPLACE BANCO     WITH XBANCO
         REPLACE CTABANCO  WITH XCTABANCO
         REPLACE MONTO     WITH WTOTLIQ
      ELSE
         IF WTOTLIQ < 0
            STORE "ERROR, SOBRE DE :"+XCEDULA+" PRESENTA SALDO  NEGATIVO" TO MES
            DO AVISO WITH MES
            STORE "POR LO TANTO, NO SERA INCLUIDO" TO MES
            DO AVISO WITH MES
         ENDIF
      ENDIF
      SELECT 1
      SKIP
   ENDDO
   SELECT 5
   DO RECLOC
   REPLACE ESTADO WITH 6
   UNLOCK 
   SKIP
ENDDO
EJECT
SET DEVI TO SCRE
CLOSE DATA
CLOSE INDEX

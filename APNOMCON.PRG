* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE2.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO1.IDX" TO QCONIDX  . /
* STORE WGRUPO         TO QGRUPO
* STORE WNOMINA        TO QNOMINA
* STORE WF1            TO QDESDE
* STORE WF2            TO QHASTA

SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APNOMCON
COPY STRU TO &WUSERCODE
SELECT 3
USE &WUSERCODE
INDEX ON GRUPO+NOMINA+DIRE+DEPA+SECC+CONCEPTO TO &WUSERCODE
SELECT 5
USE APNOMINA INDEX APNOMINA

SELECT 5
FIND &QGRUPO
DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO
   IF QNOMINA <> SPACE(2) .AND. NOMINA <> QNOMINA
      SELECT 5
      SKIP
      LOOP
   ENDIF
   STORE NOMINA TO QQNOMINA
   SELECT 1
   STORE QGRUPO+QQNOMINA+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVE1
   FIND &WCLAVE1
   IF EOF()
      STORE "ERROR, NO HAY INFORMACION PARA NOMINA:"+QQNOMINA+" EN ESTA FECHA DE CIERRE" TO MES
      DO AVISO WITH MES
      STORE "RECOMENDAMOS SOLICITAR NOMINA POR NOMINA, OPRIMA <ENTER>." TO MES
      DO AVISO WITH MES
      CLOSE DATA
      CLOSE INDEX
      RETURN
   ENDIF
   DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO .AND. NOMINA = QQNOMINA  FECHA2 >=QDESDE .AND. FECHA2 <=QHASTA
      STORE GRUPO  TO XGRUPO
      STORE NOMINA TO XNOMINA
      STORE DIRE   TO XDIRE
      STORE DEPA   TO XDEPA
      STORE SECC   TO XSECC
      STORE CEDULA TO XCEDULA
      STORE FECHA2 TO XFECHA
      STORE XCEDULA+STR(YEAR(XFECHA))+STR(MONTH(XFECHA))+STR(DAY(XFECHA)) TO WCLAVE2
      SELECT 2
      FIND &WCLAVE2
      DO WHILE .NOT. EOF() .AND. CEDULA=XCEDULA .AND. FECHA2=XFECHA
         STORE CONCEPTO TO XCONCEPTO
         STORE MONTO    TO XMONTO
         *** ACTUALIZA A NIVEL DE SECCION
         IF XSECC <> SPACE(3) 
            STORE XGRUPO+XNOMINA+XDIRE+XDEPA+XSECC+XCONCEPTO TO WCLAVE3
            SELECT 3
            FIND &WCLAVE3
            IF EOF()
               DO FILLOC
               APPEND BLANK
               UNLOCK
               DO RECLOC
               REPLACE GRUPO    WITH XGRUPO
               REPLACE NOMINA   WITH XNOMINA
               REPLACE DIRE     WITH XDIRE
               REPLACE DEPA     WITH XDEPA
               REPLACE SECC     WITH XSECC
               REPLACE CONCEPTO WITH XCONCEPTO
            ENDIF
            DO RECLOC
            REPLACE SOBRES WITH SOBRES + 1
            REPLACE MONTO WITH MONTO + XMONTO
            UNLOCK
         ENDIF
         *** ACTUALIZA A NIVEL DE DEPARTAMENTO
         IF XDEPA <> SPACE(2) 
            STORE XGRUPO+XNOMINA+XDIRE+XDEPA+SPACE(3)+XCONCEPTO TO WCLAVE3
            SELECT 3
            FIND &WCLAVE3
            IF EOF()
               DO FILLOC
               APPEND BLANK
               UNLOCK
               DO RECLOC
               REPLACE GRUPO    WITH XGRUPO
               REPLACE NOMINA   WITH XNOMINA
               REPLACE DIRE     WITH XDIRE
               REPLACE DEPA     WITH XDEPA
               REPLACE SECC     WITH SPACE(3)
               REPLACE CONCEPTO WITH XCONCEPTO
            ENDIF
            DO RECLOC
            REPLACE SOBRES WITH SOBRES + 1
            REPLACE MONTO WITH MONTO + XMONTO
            UNLOCK
         ENDIF
         *** ACTUALIZA A NIVEL DE DIRECCION
         IF XDIRE <> SPACE(2) 
            STORE XGRUPO+XNOMINA+XDIRE+SPACE(2)+SPACE(3)+XCONCEPTO TO WCLAVE3
            SELECT 3
            FIND &WCLAVE3
            IF EOF()
               DO FILLOC
               APPEND BLANK
               UNLOCK
               DO RECLOC
               REPLACE GRUPO    WITH XGRUPO
               REPLACE NOMINA   WITH XNOMINA
               REPLACE DIRE     WITH XDIRE
               REPLACE DEPA     WITH SPACE(2)
               REPLACE SECC     WITH SPACE(3)
               REPLACE CONCEPTO WITH XCONCEPTO
            ENDIF
            DO RECLOC
            REPLACE SOBRES WITH SOBRES + 1
            REPLACE MONTO WITH MONTO + XMONTO
            UNLOCK
         ENDIF
         *** ACTUALIZA A NIVEL DE NOMINA
         IF XNOMINA <> SPACE(2)
            STORE XGRUPO+XNOMINA+SPACE(2)+SPACE(2)+SPACE(3)+XCONCEPTO TO WCLAVE3
            SELECT 3
            FIND &WCLAVE3
            IF EOF()
               DO FILLOC
               APPEND BLANK
               UNLOCK
               DO RECLOC
               REPLACE GRUPO    WITH XGRUPO
               REPLACE NOMINA   WITH XNOMINA
               REPLACE DIRE     WITH SPACE(2)
               REPLACE DEPA     WITH SPACE(2)
               REPLACE SECC     WITH SPACE(3)
               REPLACE CONCEPTO WITH XCONCEPTO
            ENDIF
            DO RECLOC
            REPLACE SOBRES WITH SOBRES + 1
            REPLACE MONTO WITH MONTO + XMONTO
            UNLOCK
         ENDIF
         *** ACTUALIZA A NIVEL DE GRUPO
         IF XGRUPO <> SPACE(2)
            STORE XGRUPO+SPACE(2)+SPACE(2)+SPACE(2)+SPACE(3)+XCONCEPTO TO WCLAVE3
            SELECT 3
            FIND &WCLAVE3
            IF EOF()
               DO FILLOC
               APPEND BLANK
               UNLOCK
               DO RECLOC
               REPLACE GRUPO    WITH XGRUPO
               REPLACE NOMINA   WITH SPACE(2)
               REPLACE DIRE     WITH SPACE(2)
               REPLACE DEPA     WITH SPACE(2)
               REPLACE SECC     WITH SPACE(3)
               REPLACE CONCEPTO WITH XCONCEPTO
            ENDIF
            DO RECLOC
            REPLACE SOBRES WITH SOBRES + 1
            REPLACE MONTO WITH MONTO + XMONTO
            UNLOCK
         ENDIF
         SELECT 2
         SKIP
      ENDDO
      SELECT 1
      SKIP
   ENDDO
   SELECT 5
   DO RECLOC
   if sw=1
      REPLACE ESTADO WITH 4
   endif
   UNLOCK
   SKIP
ENDDO
CLOSE DATA
CLOSE INDEX
***
*** INICIO FASE DE EMISION DE RESULTADOS
***
SELECT 1
USE APGRUPOS INDEX APGRUPOS
SELECT 2
USE APNOMINA INDEX APNOMINA
SELECT 3
USE APUBICA INDEX APUBICA
SELECT 4
USE &WUSERCODE INDEX &WUSERCODE
SELECT 5
USE APCON INDEX APCON
SET DEVI  TO PRINT
STORE 0   TO WPAGE
STORE 100 TO WLINE
STORE 0 TO WTOTNOMASI
STORE 0 TO WTOTNOMDEC
STORE 0 TO WTOTGENASI
STORE 0 TO WTOTGENDEC
SELECT 4
GO TOP
STORE "**" TO WRUPGRUPO
STORE "**" TO WRUPNOMINA
STORE "**" TO WRUPDIRE
STORE "**" TO WRUPDEPA
STORE "***" TO WRUPSECC
DO WHILE .NOT. EOF()
   *** CHEQUEO DE SALTO DE PAGINA CON RUPTURA SOLO PARA VER TITULOS
   STORE WLINE+1 TO WLINE
   IF WLINE >=55
      STORE .T. TO WFLAGRUP
      DO RUNOMCON
      SELECT 4
   ENDIF
   *** CHEQUEO DE RUPTURA REAL
   STORE .F. TO WFLAGRUP
   DO RUNOMCON
   SELECT 4
   ***
   STORE CONCEPTO TO ZCONCEPTO
   STORE MONTO    TO ZMONTO
   STORE SOBRES   TO ZSOBRES
   SELECT 5
   FIND &ZCONCEPTO
   IF EOF()
      STORE "CONCEPTO NO REGISTRADO" TO ZCONDES
      STORE 1                        TO WASIDEC
   ELSE
      STORE DESCRI                   TO ZCONDES
      STORE GRUPO                    TO WASIDEC
   ENDIF
   @ WLINE,00 SAY ZCONCEPTO
   @ WLINE,10 SAY ZCONDES
   IF WASIDEC = 1
      @ WLINE,36 SAY ZMONTO PICTURE "###,###,###.##"
      STORE WTOTNOMASI+ZMONTO TO WTOTNOMASI
      STORE WTOTGENASI+ZMONTO TO WTOTGENASI
   ELSE
      @ WLINE,51 SAY ZMONTO PICTURE "###,###,###.##"
      STORE WTOTNOMDEC+ZMONTO TO WTOTNOMDEC
      STORE WTOTGENDEC+ZMONTO TO WTOTGENDEC
   ENDIF
   @ WLINE,70 SAY ZSOBRES PICTURE "##########" 
   SELECT 4
   SKIP
ENDDO
DO TTNOMCON
**** RESUMEN GENERAL DE LA NOMINA CONCEPTUAL
STORE 0   TO WPAGE
STORE 100 TO WLINE
SELECT 4
GO TOP
DO WHILE .NOT. EOF()
   *** CHEQUEO DE SALTO DE PAGINA 
   STORE WLINE+1 TO WLINE
   IF WLINE >=55
      @ 00,00 SAY CHR(14)+QQWW
      @ 02,00 SAY "NOMINA CONCEPTUAL (RESUMEN GENERAL)"
      @ 02,60 SAY "FECHA :"+DTOC(DATE())
      @ 03,60 SAY "PAGINA:"+STR(WPAGE,3)
      @ 05,00 SAY "GP.NM.DR.DP.SEC.  CONCEPTO                                      MONTO No.PERSONAS"
      @ 06,00 SAY "-- -- -- -- ---   -----------------------------------  -------------- -----------"
      STORE 07 TO WLINE
   ENDIF
   STORE CONCEPTO TO ZCONCEPTO
   STORE MONTO    TO ZMONTO
   STORE SOBRES   TO ZSOBRES
   SELECT 5
   FIND &ZCONCEPTO
   IF EOF()
      STORE "CONCEPTO NO REGISTRADO" TO ZCONDES
   ELSE
      STORE DESCRI                   TO ZCONDES
   ENDIF
   SELECT 4
   @ WLINE,00 SAY GRUPO
   @ WLINE,03 SAY NOMINA
   @ WLINE,06 SAY DIRE
   @ WLINE,09 SAY DEPA
   @ WLINE,12 SAY SECC
   @ WLINE,18 SAY ZCONCEPTO
   @ WLINE,23 SAY ZCONDES
   @ WLINE,55 SAY ZMONTO PICTURE "###,###,###.##"
   @ WLINE,70 SAY ZSOBRES PICTURE "#########"
   SELECT 4
   SKIP
ENDDO
SET DEVI TO SCRE
EJECT
CLOSE DATA
CLOSE INDEX
DELETE FILE &QAPNOMCON.DBF
DELETE FILE &QAPNOMCON.IDX
RETURN

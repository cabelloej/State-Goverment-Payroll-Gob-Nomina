* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE2.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO1.IDX" TO QCONIDX  . /
* STORE WGRUPO         TO QGRUPO
* STORE WNOMINA        TO QNOMINA
* STORE WF1            TO QDESDE
* STORE WF2            TO QHASTA
SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APCON INDEX APCON
SELECT 4
USE APPERSON INDEX APPERSO1
SELECT 5
USE APNOMINA INDEX APNOMINA
SELECT 6
USE APUBICA  INDEX APUBICA
SELECT 7
USE APCARGOS INDEX APCARGOS

*** CREA LAS TABLAS DEL TITULO
STORE 50 TO WMAXA
STORE 50 TO WMAXD
DIME TABLAA(WMAXA,4)
DIME TABLAD(WMAXD,4)
STORE 0 TO WCTA
STORE 0 TO WCTD
SELECT 3
GO TOP
DO WHILE.NOT.EOF()
   IF GRUPO = 1
      STORE WCTA+1 TO WCTA
      IF WCTA>=WMAXA
         STORE "****"         TO TABLAA(WCTA,1)
         STORE "ASIGNACIONES" TO TABLAA(WCTA,2)
         STORE "VARIAS"       TO TABLAA(WCTA,3)
         EXIT
      ELSE
         STORE CODIGO         TO TABLAA(WCTA,1)
         STORE DESCRIR1       TO TABLAA(WCTA,2)
         STORE DESCRIR2       TO TABLAA(WCTA,3)
      ENDIF
   ENDIF
   SKIP
ENDDO
SELECT 3
GO TOP
DO WHILE.NOT.EOF()
   IF GRUPO = 2
      STORE WCTD+1 TO WCTD
      IF WCTD>=WMAXD
         STORE "****"         TO TABLAD(WCTD,1)
         STORE "DEDUCCIONES " TO TABLAD(WCTD,2)
         STORE "VARIAS"       TO TABLAD(WCTD,3)
         EXIT
      ELSE
         STORE CODIGO         TO TABLAD(WCTD,1)
         STORE DESCRIR1       TO TABLAD(WCTD,2)
         STORE DESCRIR2       TO TABLAD(WCTD,3)
      ENDIF
   ENDIF
   SKIP
ENDDO
SET DEVI TO PRINT
STORE "**"  TO WRUPGRUPO
STORE "**"  TO WRUPNOMINA
STORE 100 TO WLINE
STORE 0   TO WPAGINA
STORE 45  TO WSALTO
SELECT 5
FIND &QGRUPO
DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO
   IF QNOMINA <> SPACE(2) .AND. NOMINA <> QNOMINA
      SELECT 5
      SKIP
      LOOP
   ENDIF
   STORE NOMINA  TO QQNOMINA
   STORE DESCRI  TO WNOMIDES
   STORE 0       TO WTOTGASI
   STORE 0       TO WTOTGDEC
   STORE 0       TO WTOTGLIQ
   SELECT 1
   STORE QGRUPO+QQNOMINA+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVE1
   FIND &WCLAVE1
   IF EOF()
      STORE "ERROR, NO HAY INFORMACION PARA NOMINA:"+QQNOMINA+" EN ESTA FECHA DE CIERRE" TO MES
      DO AVISO WITH MES
      STORE "RECOMENDAMOS SOLICITAR NOMINA POR NOMINA, OPRIMA <ENTER>." TO MES
      DO AVISO WITH MES
      EXIT
   ENDIF
   DO WHILE .NOT. EOF() .AND. GRUPO = QGRUPO .AND. NOMINA = QQNOMINA .AND. FECHA2 >=QDESDE .AND. FECHA2 <=QHASTA
      STORE CARGO   TO  XCARGO
      STORE CEDULA  TO  XCEDULA
      STORE FECHA1  TO  XFECHA1
      STORE FECHA2  TO  XFECHA2
      STORE GRUPO   TO  XGRUPO
      STORE NOMINA  TO  XNOMINA
      STORE DIRE    TO  XDIRE
      STORE DEPA    TO  XDEPA
      STORE SECC    TO  XSECC
      STORE SUELDOH TO  XSUELDOH
      STORE SUELDOD TO  XSUELDOD
      STORE SUELDOP TO  XSUELDOP
      STORE TIPO    TO  XTIPO
      STORE FECHA2  TO  XFECHA
      STORE 0       TO WTOTBON
      STORE 0       TO WTOTNBON
      STORE 0       TO WTOTASI
      STORE 0       TO WTOTDEC
      STORE 0       TO WTOTLIQ
      SELECT 4
      FIND &XCEDULA
      IF EOF()
         STORE "NO REGISTRADO" TO XAPELLIDOS
         STORE " "             TO XNOMBRES
         STORE 0               TO XSUELDO
      ELSE
         STORE APELLIDOS       TO XAPELLIDOS
         STORE NOMBRES         TO XNOMBRES
         IF TIPO = "E".OR.TIPO="P".OR.TIPO="J"
            STORE SUELDOP       TO XSUELDO
         ELSE
            STORE SUELDOD       TO XSUELDO
         ENDIF
      ENDIF
      IF XCARGO <> SPACE(4)
         SELECT 7
         FIND &XCARGO
         IF EOF()
            STORE "NO REGISTRADO" TO XCARGODES
         ELSE
            STORE DESCRI          TO XCARGODES
         ENDIF
      ELSE
         STORE    "NO DEFINIDO"   TO XCARGODES
      ENDIF
      *** LIMPIA TABLAS
      STORE 1 TO WCONTADOR
      DO WHILE WCONTADOR<=WCTA
         STORE 0 TO TABLAA(WCONTADOR,4)
         STORE WCONTADOR+1 TO WCONTADOR
      ENDDO
      STORE 1 TO WCONTADOR
      DO WHILE WCONTADOR<=WCTD
         STORE 0 TO TABLAD(WCONTADOR,4)
         STORE WCONTADOR+1 TO WCONTADOR
      ENDDO
      ***
      STORE XCEDULA+STR(YEAR(XFECHA))+STR(MONTH(XFECHA))+STR(DAY(XFECHA)) TO WCLAVE2
      SELECT 2
      FIND &WCLAVE2
      DO WHILE .NOT. EOF() .AND. CEDULA=XCEDULA .AND. FECHA2=XFECHA
         STORE CONCEPTO TO XCONCEPTO
         STORE CANTIDAD TO XCANTIDAD
         STORE MONTO    TO XMONTO
         ** SEEK PARA RUTINA TOTALIZA
         SELECT 3
         SEEK XCONCEPTO
         IF FOUND()
            STORE GRUPO TO XGRUPO
         ELSE
            STORE 0     TO XGRUPO
         ENDIF
         *** UBICA EL MONTO EN LAS TABLAS
         IF XGRUPO=1
            STORE 1 TO WCONTADOR
            DO WHILE WCONTADOR<=WCTA
               IF TABLAA(WCONTADOR,1)=XCONCEPTO
                  STORE XMONTO TO TABLAA(WCONTADOR,4)
                  EXIT
               ENDIF
               STORE WCONTADOR+1 TO WCONTADOR
            ENDDO
            *** GRABA EN EL ULTIMO SI NO LO ENCONTRO
            IF WCONTADOR>WCTA
               STORE XMONTO TO TABLAA(WCTA,4)
            ENDIF
         ELSE
            IF XGRUPO=2
               STORE 1 TO WCONTADOR
               DO WHILE WCONTADOR<=WCTD
                  IF TABLAD(WCONTADOR,1)=XCONCEPTO
                     STORE XMONTO TO TABLAD(WCONTADOR,4)
                     EXIT
                  ENDIF
                  STORE WCONTADOR+1 TO WCONTADOR
               ENDDO
               *** GRABA EN EL ULTIMO SI NO LO ENCONTRO
               IF WCONTADOR>WCTD
                  STORE XMONTO TO TABLAD(WCTD,4)
               ENDIF
            ENDIF
         ENDIF
         DO TOTALIZA
         ********
         SELECT 2
         SKIP
      ENDDO
      *** IMPRIME LA PERSONA
      STORE WLINE+1 TO WLINE
      IF WLINE>WSALTO
         DO HDNOMHOR
      ENDIF
      DO LININT
      DO LNNOMHOR
      STORE WTOTGASI+WTOTASI TO WTOTGASI
      STORE WTOTGDEC+WTOTDEC TO WTOTGDEC
      STORE WTOTGLIQ+WTOTLIQ TO WTOTGLIQ
      SELECT 1
      SKIP
   ENDDO
   STORE WLINE+1 TO WLINE
   IF WLINE>WSALTO
      DO HDNOMHOR
   ENDIF
   DO LINEXT
   IF WTOTGASI>0 .OR. WTOTGDEC > 0
      STORE WLINE+1 TO WLINE
      @ WLINE,00  SAY "T O T A L E S :  ";
                     +"   ASIGNACIONES: "+STR(WTOTGASI,14,2)+;
                     +"    DEDUCCIONES: "+STR(WTOTGDEC,14,2)+;
                     +"  NETO A COBRAR: "+STR(WTOTGLIQ,14,2)
   ENDIF
   SELECT 5
   DO RECLOC
   if sw=0
      REPLACE ESTADO WITH 7
   endif
   UNLOCK
   SKIP
ENDDO
@ PROW(), PCOL() SAY CHR(18)
SET DEVI TO SCRE
CLOSE DATA
CLOSE INDEX
RETURN
*************
PROC HDNOMHOR
*************
@ 00,00 SAY QQWW
@ 01,00 SAY "NOMINA :"+QQNOMINA+" "+WNOMIDES
@ 02,00 SAY "PERIODO QUE CIERRA EL "+DTOC(QHASTA)
@ 03,00 SAY CHR(15)
STORE 3 TO WLINE
DO LINEXT
STORE WLINE+1 TO WLINE
DO LININT
DO LINAD1
STORE WLINE+1 TO WLINE
DO LININT
DO LINAD2
STORE WLINE+1 TO WLINE
DO LINEXT
STORE WLINE+1 TO WLINE
RETURN
***********
PROC LINEXT
***********
STORE "+-----------------------------+" TO WCADENA
STORE 1 TO WCON
DO WHILE WCON<=WCTA+WCTD+2
   STORE WCADENA+REPLICATE("-",12)+"+"  TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
@ WLINE,00 SAY WCADENA
RETURN
***********
PROC LININT
***********
STORE "|                             |" TO WCADENA
STORE 1 TO WCON
DO WHILE WCON<=WCTA+WCTD+2
   STORE WCADENA+REPLICATE(" ",12)+"|"  TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
@ WLINE,00 SAY WCADENA
RETURN
*************
PROC LINAD1
*************
STORE " "+"NOMBRE(S) y APELLIDO(S)       " TO WCADENA
STORE 1 TO WCON
DO WHILE WCON<=WCTA
   STORE WCADENA+TABLAA(WCON,2)+" "        TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
STORE 1 TO WCON
DO WHILE WCON<=WCTD
   STORE WCADENA+TABLAD(WCON,2)+" "        TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
*** CASILLAS ADICIONALES
STORE WCADENA+"       TOTAL"+" "           TO WCADENA
STORE WCADENA+"        NETO"               TO WCADENA
@ WLINE,00 SAY WCADENA
RETURN
***********
PROC LINAD2
***********
STORE " "+"No. DE CEDULA                 " TO WCADENA
STORE 1 TO WCON
DO WHILE WCON<=WCTA
   STORE WCADENA+TABLAA(WCON,3)+" "        TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
STORE 1 TO WCON
DO WHILE WCON<=WCTD
   STORE WCADENA+TABLAD(WCON,3)+" "        TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
*** CASILLAS ADICIONALES
STORE WCADENA+" DEDUCCIONES"+" "           TO WCADENA
STORE WCADENA+"      COBRAR"               TO WCADENA
@ WLINE,00 SAY WCADENA
RETURN
*************
PROC LNNOMHOR
*************
STORE " "+RTRIM(XAPELLIDOS)+", "+RTRIM(XNOMBRES)+SPACE(30) TO WCADENA
STORE SUBSTR(WCADENA,1,30)                       TO WCADENA
STORE 1 TO WCON
DO WHILE WCON<=WCTA
   STORE WCADENA+STR(TABLAA(WCON,4),12,2)+" "    TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
STORE 1 TO WCON
DO WHILE WCON<=WCTD
   STORE WCADENA+STR(TABLAD(WCON,4),12,2)+" "    TO WCADENA
   STORE WCON+1 TO WCON
ENDDO
*** CASILLAS ADICIONALES
STORE WCADENA+STR(WTOTDEC,12,2)+" "              TO WCADENA
STORE WCADENA+STR(WTOTLIQ,12,2)+" "              TO WCADENA
@ WLINE,00 SAY WCADENA
STORE WLINE+1 TO WLINE
DO LININT
@ WLINE, 1 SAY XCEDULA
RETURN

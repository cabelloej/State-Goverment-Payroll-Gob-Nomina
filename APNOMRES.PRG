* DEBE RECIBIR PARA SU FUNCIONAMIENTO:
* STORE "AP???GEN.DBF" TO QGENFIL  . \
* STORE "AP???GE1.IDX" TO QGENIDX  .  \PROCEDENCIA DE LA INFORMACION
* STORE "AP???CON.DBF" TO QCONFIL  .  /
* STORE "AP???CO2.IDX" TO QCONIDX  . /
* STORE WTIPPER        TO QTIPPER
* STORE ZGRUPO         TO QGRUPO
* STORE ZNOMINA        TO QNOMINA
* STORE WXAP1          TO QDESDE
* STORE WXAP2          TO QHASTA
* STORE ZCONCEPTO      TO QCONCEPTO

SELECT 1
USE &QGENFIL INDEX &QGENIDX
SELECT 2
USE &QCONFIL INDEX &QCONIDX
SELECT 3
USE APPERSON INDEX APPERSO2
SELECT 4
USE APGRUPOS INDEX APGRUPOS
SELECT 5
USE APNOMINA INDEX APNOMINA
SELECT 6
USE APNOMRES
COPY STRU TO &WUSERCODE
SELECT 6
USE &WUSERCODE
INDEX ON GRUPO+NOMINA+CEDULA+STR(YEAR(FECHA))+STR(MONTH(FECHA))+STR(DAY(FECHA)) TO &WUSERCODE
SELECT 7
USE APCONPER INDEX APCONPER

STORE QCONCEPTO+STR(YEAR(QDESDE))+STR(MONTH(QDESDE))+STR(DAY(QDESDE)) TO WCLAVECON 
SELECT 2
FIND &WCLAVECON
DO WHILE .NOT. EOF() .AND. CONCEPTO = QCONCEPTO
   STORE CEDULA TO QCEDULA
   STORE FECHA2 TO QFECHA2
   IF QFECHA2>=QDESDE.AND.QFECHA2<=QHASTA
      *** PASA BIEN
   ELSE
      EXIT
   ENDIF
   STORE QCEDULA+STR(YEAR(QFECHA2))+STR(MONTH(QFECHA2))+STR(DAY(QFECHA2)) TO WCLAVEPER 
   SELECT 1
   FIND &WCLAVEPER
   IF EOF()
      STORE "ERROR, CEDULA :"+QCEDULA+" FECHA:"+DTOC(QFECHA2)+" SIN DATOS GENERALES" TO MES
      DO AVISO WITH MES
      SELECT 2
      SKIP
      LOOP
   ENDIF
   IF TIPO <> QTIPPER
      SELECT 2
      SKIP 
      LOOP
   ENDIF
   IF QGRUPO <> SPACE(2) .AND. QGRUPO <> GRUPO
      SELECT 2
      SKIP
      LOOP
   ENDIF
   IF QNOMINA <> SPACE(2) .AND. QNOMINA <> NOMINA
      SELECT 2
      SKIP
      LOOP
   ENDIF
   *** FIN DE FILTROS ***
   SELECT 1
   STORE GRUPO     TO WXGRUPO
   STORE NOMINA    TO WXNOMINA
   STORE QCEDULA   TO WXCEDULA
   STORE QFECHA2   TO WXFECHA
   STORE QCONCEPTO TO WXCONCEPTO
   SELECT 2
   STORE MONTO     TO WXMONTO
   STORE SALDO     TO WXSALDO
   SELECT 7
   SEEK QCEDULA+QCONCEPTO
   IF FOUND()
      STORE REFER  TO WXREFER
   ELSE
      STORE " "    TO WXREFER
   ENDIF

   SELECT 6
   DO FILLOC
   APPEND BLANK
   UNLOCK
   DO RECLOC
   REPLACE GRUPO    WITH WXGRUPO
   REPLACE NOMINA   WITH WXNOMINA
   REPLACE CEDULA   WITH WXCEDULA
   REPLACE FECHA    WITH WXFECHA
   REPLACE MONTO    WITH WXMONTO
   REPLACE SALDO    WITH WXSALDO
   REPLACE REFER    WITH WXREFER
   UNLOCK
   SELECT 2
   SKIP
ENDDO
CLOSE DATA
CLOSE INDEX
***
*** INICIO FASE DE EMISION DE RESULTADOS
***
SELECT 1
USE APGRUPOS   INDEX APGRUPOS
SELECT 2
USE APNOMINA   INDEX APNOMINA
SELECT 3
USE APPERSON   INDEX APPERSO1
SELECT 4
USE &WUSERCODE INDEX &WUSERCODE
SET DEVI  TO PRINT
STORE 0   TO WPAGE
STORE 100 TO WLINE
STORE 0   TO WTOTNOM
STORE 0   TO WTOTGEN
STORE 0   TO WCONTADOR
SELECT 4
GO TOP
STORE "**" TO WRUPGRUPO
STORE "**" TO WRUPNOMINA
DO WHILE .NOT. EOF()
   STORE WLINE+1 TO WLINE
   STORE WCONTADOR + 1 TO WCONTADOR
   *** CHEQUEO DE SALTO DE PAGINA Y/O RUPTURA 
   DO RUNOMRES
   SELECT 4
   ***
   STORE CEDULA TO ZCEDULA
   SELECT 3
   FIND &ZCEDULA
   IF EOF()
      STORE "CEDULA NO REGISTRADO" TO ZNOMBRES
   ELSE
      STORE substr( RTRIM(APELLIDOS)+", "+RTRIM(NOMBRES),1,29) TO ZNOMBRES
   ENDIF
   SELECT 4
   @ WLINE,00 SAY WCONTADOR PICTURE "####"      
   @ WLINE,05 SAY CEDULA
   @ WLINE,18 SAY ZNOMBRES
   @ WLINE,49 SAY REFER
   @ WLINE,84 SAY FECHA
   @ WLINE,92 SAY MONTO PICTURE "#######.##"
   @ WLINE,106 SAY SALDO PICTURE "#######.##"
   STORE WTOTNOM + MONTO TO WTOTNOM
   STORE WTOTGEN + MONTO TO WTOTGEN
   SELECT 4
   SKIP
ENDDO
IF WTOTNOM > 0 
   STORE WLINE + 2 TO WLINE
   @ WLINE,0  SAY "TOTAL NOMINA"
   @ WLINE,84 SAY WTOTNOM PICTURE "####,###,###.##"
ENDIF 
IF WTOTGEN > 0 
   STORE WLINE + 1 TO WLINE
   @ WLINE,0  SAY REPLICATE("-",81)
   STORE WLINE + 1 TO WLINE
   @ WLINE,0  SAY "TOTAL RESUMEN"
   @ WLINE,84 SAY WTOTGEN PICTURE "####,###,###.##"
   STORE 0 TO WTOTNOM
ENDIF 
EJECT
SET DEVI TO SCRE
CLOSE DATA
CLOSE INDEX
DELETE FILE &QAPNOMCON.DBF
DELETE FILE &QAPNOMCON.IDX
RETURN
